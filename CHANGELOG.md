# Changelog

本项目的所有重要变更都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [Semantic Versioning](https://semver.org/lang/zh-CN/)。

---

## [0.8.0-katelya] - 2025-11-12

### 🎉 重大变更

#### 播放页面完全重构
- **完全重写播放页面** - 将1900行单一文件拆分为13个职责清晰的模块
- **代码减少67%** - 主页面从1900行减少到600行
- **架构优化** - 采用自定义Hooks模式，实现业务逻辑与UI分离

### ✨ 新增功能

#### 类型系统
- 新增完整的TypeScript类型定义系统（`types/player.types.ts`）
- 40+个类型定义，消除所有`any`类型使用
- 完全类型安全的开发体验

#### 自定义Hooks
- `useVideoPlayer` - 核心播放器逻辑管理（280行）
- `usePlaybackHistory` - 播放历史自动保存和恢复
- `useFavorite` - 收藏功能管理
- `useKeyboardShortcuts` - 统一键盘快捷键管理
- `useVideoData` - 视频数据加载与智能源优选
- `useSourceSelection` - 换源管理与错误恢复

#### UI组件
- `VideoPlayer` - 播放器容器组件
- `VideoInfo` - 视频信息展示组件
- `FavoriteButton` - 独立的收藏按钮组件

#### 工具函数
- 新增播放器工具函数模块（`utils/player.utils.ts`）
- 新增URL参数管理模块（`utils/url.utils.ts`）
- 提取广告过滤为独立模块（`AdFilterLoader.ts`）

### 🐛 Bug修复

#### 高优先级问题（4/4）
- **修复播放器内存泄漏** - 完整的cleanup函数，正确清理所有事件监听器和HLS实例
- **修复重复的timeupdate监听器** - 合并为单一监听器，避免重复处理
- **添加错误边界** - 完善的加载和错误状态处理
- **修复换源状态混乱** - 使用状态快照模式，支持完整错误恢复

#### 中优先级问题（3个）
- **改进Safari浏览器检测** - 更可靠的检测逻辑
- **动态保存间隔** - 根据存储类型自动调整保存频率
- **完善URL参数同步** - 集中化管理，确保参数完整性

### 🚀 性能优化

- **避免不必要的重渲染** - 使用ref存储不触发渲染的值
- **智能节流** - 播放进度保存采用智能节流策略
- **内存管理** - 完善的资源清理，防止内存泄漏
- **代码分割** - 模块化设计，按需加载

### 📝 文档改进

- 新增播放页面重构完成报告（详细的实现说明和测试指南）
- 归档所有历史分析和优化文档
- 创建完整的代码使用示例和扩展指南

### 🔧 项目结构

#### 新增目录
```
src/app/play/
├── types/              # 类型定义
├── utils/              # 工具函数
├── hooks/              # 自定义Hooks（6个）
└── components/         # UI组件
    ├── VideoPlayer/
    └── VideoInfo/
```

#### 归档目录
```
docs/archives/
├── 2025-11-12-play-page-refactor/   # 播放页面重构文档
└── 2025-11-12-optimization/         # 历史优化文档
```

### 🗑️ 移除

- 删除旧版本代码备份（`page.old.tsx`）
- 移除根目录下的临时文档（已归档到`docs/archives/`）

### 📊 统计数据

| 指标 | 变化 |
|------|------|
| 主页面代码行数 | 1900行 → 600行（↓67%） |
| 单文件最大行数 | 1900行 → 280行（↓85%） |
| 模块文件数量 | 1个 → 13个（+1200%） |
| 类型安全性 | 部分 → 完全类型化（✓） |
| 测试难度 | 困难 → 简单（✓） |

### ⚙️ 技术栈

保持不变：
- Next.js 14.2.23
- React 18.2.0
- TypeScript 4.9.5
- Artplayer 5.2.3
- HLS.js 1.6.6
- Tailwind CSS 3.4.17

---

## [0.7.0-katelya] - 之前版本

历史版本的变更记录请参考 `docs/archives/` 中的相关文档。

### 主要功能
- 视频播放功能
- 智能源优选
- 播放历史记录
- 收藏功能
- 跳过片头片尾
- 换源功能
- 广告过滤

---

## 版本命名说明

版本格式：`主版本.次版本.修订版本-katelya`

- **主版本**：重大架构变更或不兼容的API修改
- **次版本**：新功能添加，向后兼容
- **修订版本**：Bug修复和小改进
- **-katelya**：项目标识后缀

---

## 相关链接

- [播放页面重构完成报告](docs/archives/2025-11-12-play-page-refactor/播放页面重构完成报告.md)
- [历史文档归档](docs/archives/)
- [项目README](README.md)
