# ğŸ”„ æ’­æ”¾é¡µé¢é‡æ„è®¡åˆ’

> V0TV é¡¹ç›® - æ’­æ”¾é¡µé¢æœ€ä½³å®è·µé‡æ„

---

## ğŸ“‹ é‡æ„æ¦‚è¿°

**å½“å‰çŠ¶å†µ**:

- å•æ–‡ä»¶ 1900+ è¡Œ
- é€»è¾‘æ··æ‚ï¼Œéš¾ä»¥ç»´æŠ¤
- ç±»å‹ä¸å®‰å…¨ï¼Œè¿‡å¤š any

**ç›®æ ‡**:

- âœ… æ¸…æ™°çš„æ–‡ä»¶ç»“æ„
- âœ… å…³æ³¨ç‚¹åˆ†ç¦»
- âœ… ç±»å‹å®‰å…¨
- âœ… å¯å¤ç”¨æ€§é«˜
- âœ… æ˜“äºæµ‹è¯•

---

## ğŸ—‚ï¸ æ–°æ–‡ä»¶ç»“æ„

```
src/app/play/
â”œâ”€â”€ page.tsx                          # ä¸»é¡µé¢å…¥å£ï¼ˆ~150è¡Œï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ VideoPlayer/
â”‚   â”‚   â”œâ”€â”€ index.tsx                 # æ’­æ”¾å™¨ä¸»ç»„ä»¶ï¼ˆ~200è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ PlayerControls.tsx       # è‡ªå®šä¹‰æ§åˆ¶æ ï¼ˆ~100è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ AdFilterLoader.ts        # å¹¿å‘Šè¿‡æ»¤åŠ è½½å™¨ï¼ˆ~100è¡Œï¼‰
â”‚   â”œâ”€â”€ EpisodeList/
â”‚   â”‚   â””â”€â”€ index.tsx                 # é€‰é›†åˆ—è¡¨ï¼ˆå·²å­˜åœ¨ï¼Œéœ€ä¼˜åŒ–ï¼‰
â”‚   â”œâ”€â”€ VideoInfo/
â”‚   â”‚   â”œâ”€â”€ index.tsx                 # è§†é¢‘ä¿¡æ¯å±•ç¤ºï¼ˆ~150è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ FavoriteButton.tsx       # æ”¶è—æŒ‰é’®ï¼ˆ~50è¡Œï¼‰
â”‚   â””â”€â”€ ErrorBoundary/
â”‚       â””â”€â”€ index.tsx                 # é”™è¯¯è¾¹ç•Œï¼ˆå·²å®Œæˆï¼‰
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useVideoPlayer.ts             # æ’­æ”¾å™¨é€»è¾‘ï¼ˆ~250è¡Œï¼‰
â”‚   â”œâ”€â”€ usePlaybackHistory.ts        # æ’­æ”¾è®°å½•ï¼ˆ~150è¡Œï¼‰
â”‚   â”œâ”€â”€ useSourceSelection.ts        # æºé€‰æ‹©å’Œæ¢æºï¼ˆ~200è¡Œï¼‰
â”‚   â”œâ”€â”€ useKeyboardShortcuts.ts      # å¿«æ·é”®ï¼ˆ~100è¡Œï¼‰
â”‚   â”œâ”€â”€ useFavorite.ts                # æ”¶è—åŠŸèƒ½ï¼ˆ~80è¡Œï¼‰
â”‚   â””â”€â”€ useVideoData.ts               # è§†é¢‘æ•°æ®è·å–ï¼ˆ~200è¡Œï¼‰
â”œâ”€â”€ types/
â”‚   â””â”€â”€ player.types.ts               # æ’­æ”¾å™¨ç±»å‹å®šä¹‰ï¼ˆ~100è¡Œï¼‰
â””â”€â”€ utils/
    â”œâ”€â”€ player.utils.ts               # æ’­æ”¾å™¨å·¥å…·å‡½æ•°ï¼ˆ~100è¡Œï¼‰
    â””â”€â”€ url.utils.ts                  # URLå¤„ç†å·¥å…·ï¼ˆ~50è¡Œï¼‰
```

**ä»£ç åˆ†å¸ƒ**:

- ä¸»é¡µé¢: ~150 è¡Œ
- ç»„ä»¶: ~700 è¡Œ
- Hooks: ~980 è¡Œ
- ç±»å‹+å·¥å…·: ~250 è¡Œ
- **æ€»è®¡**: ~2080 è¡Œï¼ˆæ¯”åŸæ¥å¤š 180 è¡Œï¼Œä½†ç»“æ„æ¸…æ™°ï¼‰

---

## ğŸ¯ æ‹†åˆ†åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)

- æ¯ä¸ªç»„ä»¶/Hook åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- é¿å…"ä¸Šå¸ç»„ä»¶"

### 2. å…³æ³¨ç‚¹åˆ†ç¦»

- **UI ç»„ä»¶**: åªè´Ÿè´£æ¸²æŸ“
- **Hooks**: å¤„ç†ä¸šåŠ¡é€»è¾‘
- **Utils**: çº¯å‡½æ•°å·¥å…·

### 3. ç±»å‹å®‰å…¨

- æ¶ˆé™¤æ‰€æœ‰ `any` ç±»å‹
- å®Œæ•´çš„ç±»å‹å®šä¹‰
- ä¸¥æ ¼çš„ null æ£€æŸ¥

### 4. å¯æµ‹è¯•æ€§

- Hook å¯ç‹¬ç«‹æµ‹è¯•
- ç»„ä»¶ props æ¸…æ™°
- å·¥å…·å‡½æ•°çº¯å‡½æ•°

---

## ğŸ“¦ è¯¦ç»†è®¾è®¡

### 1. ç±»å‹å®šä¹‰ (`types/player.types.ts`)

```typescript
import { SearchResult } from '@/lib/types';
import Artplayer from 'artplayer';

// æ’­æ”¾å™¨å®ä¾‹ç±»å‹
export type ArtPlayerInstance = Artplayer;

// æ’­æ”¾å™¨é…ç½®
export interface VideoPlayerConfig {
  url: string;
  poster: string;
  title: string;
  autoplay?: boolean;
  volume?: number;
}

// æ’­æ”¾çŠ¶æ€
export interface PlaybackState {
  currentTime: number;
  duration: number;
  isPlaying: boolean;
  volume: number;
}

// è§†é¢‘æ•°æ®
export interface VideoData {
  detail: SearchResult | null;
  currentSource: string;
  currentId: string;
  currentEpisodeIndex: number;
  videoTitle: string;
  videoYear: string;
  videoCover: string;
}

// åŠ è½½çŠ¶æ€
export type LoadingStage =
  | 'searching'
  | 'preferring'
  | 'fetching'
  | 'ready'
  | 'sourceChanging';

// é”®ç›˜å¿«æ·é”®é…ç½®
export interface KeyboardShortcut {
  key: string;
  altKey?: boolean;
  ctrlKey?: boolean;
  shiftKey?: boolean;
  handler: () => void;
  description: string;
}
```

---

### 2. æ ¸å¿ƒ Hooks è®¾è®¡

#### `useVideoPlayer.ts`

```typescript
/**
 * æ’­æ”¾å™¨æ ¸å¿ƒHook
 * èŒè´£ï¼šç®¡ç†æ’­æ”¾å™¨å®ä¾‹ã€äº‹ä»¶ç›‘å¬ã€HLSé…ç½®
 */
interface UseVideoPlayerOptions {
  url: string;
  poster: string;
  title: string;
  containerRef: React.RefObject<HTMLDivElement>;
  blockAdEnabled: boolean;
  onReady?: () => void;
  onTimeUpdate?: (time: number, duration: number) => void;
  onEnded?: () => void;
}

export function useVideoPlayer(options: UseVideoPlayerOptions) {
  const playerRef = useRef<ArtPlayerInstance | null>(null);

  // æ’­æ”¾å™¨åˆå§‹åŒ–
  useEffect(() => {
    // åˆ›å»ºæ’­æ”¾å™¨
    // æ³¨å†Œäº‹ä»¶
    // è¿”å›æ¸…ç†å‡½æ•°
  }, [options.url]);

  return {
    player: playerRef.current,
    isReady: ...,
    // æ§åˆ¶æ–¹æ³•
    play: () => {},
    pause: () => {},
    seek: (time: number) => {},
  };
}
```

#### `usePlaybackHistory.ts`

```typescript
/**
 * æ’­æ”¾è®°å½•Hook
 * èŒè´£ï¼šä¿å­˜/åŠ è½½æ’­æ”¾è¿›åº¦ã€è‡ªåŠ¨æ¢å¤
 */
export function usePlaybackHistory(
  source: string,
  id: string,
  episodeIndex: number
) {
  // åŠ è½½å†å²è®°å½•
  useEffect(() => {
    // ä»DBåŠ è½½
  }, [source, id]);

  // ä¿å­˜è¿›åº¦
  const saveProgress = useCallback((time: number, duration: number) => {
    // èŠ‚æµä¿å­˜åˆ°DB
  }, [source, id, episodeIndex]);

  return {
    resumeTime: ...,
    saveProgress,
  };
}
```

#### `useSourceSelection.ts`

```typescript
/**
 * æºé€‰æ‹©Hook
 * èŒè´£ï¼šæœç´¢æºã€æ™ºèƒ½æµ‹é€Ÿã€æ¢æºé€»è¾‘
 */
export function useSourceSelection(searchTitle: string, searchType: string) {
  const [sources, setSources] = useState<SearchResult[]>([]);
  const [loading, setLoading] = useState(false);

  // æœç´¢å¯ç”¨æº
  const searchSources = useCallback(async () => {
    // è°ƒç”¨APIæœç´¢
    // æ™ºèƒ½æµ‹é€Ÿ
    // æ’åº
  }, [searchTitle, searchType]);

  // æ¢æº
  const switchSource = useCallback(async (newSource: string, newId: string) => {
    // ä¿å­˜å½“å‰çŠ¶æ€
    // åˆ‡æ¢æº
    // é”™è¯¯æ¢å¤
  }, []);

  return {
    sources,
    loading,
    searchSources,
    switchSource,
  };
}
```

#### `useKeyboardShortcuts.ts`

```typescript
/**
 * é”®ç›˜å¿«æ·é”®Hook
 * èŒè´£ï¼šæ³¨å†Œå¿«æ·é”®ã€å¤„ç†é”®ç›˜äº‹ä»¶
 */
export function useKeyboardShortcuts(shortcuts: KeyboardShortcut[]) {
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      // åŒ¹é…å¿«æ·é”®
      // æ‰§è¡Œhandler
    };

    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [shortcuts]);
}
```

#### `useFavorite.ts`

```typescript
/**
 * æ”¶è—åŠŸèƒ½Hook
 * èŒè´£ï¼šæ”¶è—çŠ¶æ€ã€æ·»åŠ /åˆ é™¤æ”¶è—
 */
export function useFavorite(source: string, id: string) {
  const [favorited, setFavorited] = useState(false);

  // åŠ è½½æ”¶è—çŠ¶æ€
  useEffect(() => {
    // ä»DBæŸ¥è¯¢
  }, [source, id]);

  // åˆ‡æ¢æ”¶è—
  const toggleFavorite = useCallback(async () => {
    // æ·»åŠ /åˆ é™¤
  }, [source, id, favorited]);

  return { favorited, toggleFavorite };
}
```

#### `useVideoData.ts`

```typescript
/**
 * è§†é¢‘æ•°æ®Hook
 * èŒè´£ï¼šåŠ è½½è§†é¢‘è¯¦æƒ…ã€ç®¡ç†è§†é¢‘å…ƒæ•°æ®
 */
export function useVideoData(
  initialSource: string,
  initialId: string,
  needPrefer: boolean
) {
  const [data, setData] = useState<VideoData>({...});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // åŠ è½½è§†é¢‘è¯¦æƒ…
  useEffect(() => {
    // æ ¹æ®needPreferå†³å®šæ˜¯å¦ä¼˜é€‰
    // è·å–è¯¦æƒ…
    // æ›´æ–°state
  }, [initialSource, initialId]);

  return { data, loading, error, updateData: setData };
}
```

---

### 3. ç»„ä»¶è®¾è®¡

#### `VideoPlayer/index.tsx`

```typescript
/**
 * è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
 * Propsï¼šé…ç½®ã€å›è°ƒ
 * èŒè´£ï¼šæ¸²æŸ“æ’­æ”¾å™¨å®¹å™¨ã€é›†æˆuseVideoPlayer
 */
interface VideoPlayerProps {
  url: string;
  poster: string;
  title: string;
  blockAdEnabled: boolean;
  onTimeUpdate?: (time: number, duration: number) => void;
  onEnded?: () => void;
  onReady?: () => void;
}

export function VideoPlayer(props: VideoPlayerProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  const { player } = useVideoPlayer({
    ...props,
    containerRef,
  });

  return <div ref={containerRef} className='...' />;
}
```

#### `VideoInfo/index.tsx`

```typescript
/**
 * è§†é¢‘ä¿¡æ¯ç»„ä»¶
 * Propsï¼šè§†é¢‘æ•°æ®
 * èŒè´£ï¼šå±•ç¤ºæ ‡é¢˜ã€å¹´ä»½ã€ç®€ä»‹ã€å°é¢
 */
interface VideoInfoProps {
  title: string;
  year: string;
  cover: string;
  description?: string;
  className?: string;
  source?: string;
  sourceId?: string;
}

export function VideoInfo(props: VideoInfoProps) {
  const { favorited, toggleFavorite } = useFavorite(
    props.source || '',
    props.sourceId || ''
  );

  return (
    <div className={props.className}>
      <h1>{props.title}</h1>
      <FavoriteButton favorited={favorited} onClick={toggleFavorite} />
      {/* å…¶ä»–ä¿¡æ¯ */}
    </div>
  );
}
```

#### `VideoInfo/FavoriteButton.tsx`

```typescript
/**
 * æ”¶è—æŒ‰é’®ç»„ä»¶
 * Propsï¼šçŠ¶æ€ã€å›è°ƒ
 * èŒè´£ï¼šæ¸²æŸ“æ”¶è—å›¾æ ‡ã€å¤„ç†ç‚¹å‡»
 */
interface FavoriteButtonProps {
  favorited: boolean;
  onClick: () => void;
}

export function FavoriteButton({ favorited, onClick }: FavoriteButtonProps) {
  return (
    <button onClick={onClick}>
      {favorited ? <FilledHeart /> : <OutlineHeart />}
    </button>
  );
}
```

---

### 4. ä¸»é¡µé¢ç»“æ„ (`page.tsx`)

```typescript
export default function PlayPage() {
  return (
    <Suspense fallback={<LoadingUI />}>
      <PlayPageErrorBoundary>
        <PlayPageClient />
      </PlayPageErrorBoundary>
    </Suspense>
  );
}

function PlayPageClient() {
  const searchParams = useSearchParams();

  // ä½¿ç”¨å„ç§Hooks
  const videoData = useVideoData(...);
  const playbackHistory = usePlaybackHistory(...);
  const sourceSelection = useSourceSelection(...);
  const keyboardShortcuts = useKeyboardShortcuts(...);

  // ç®€å•çš„æ¸²æŸ“é€»è¾‘
  return (
    <PageLayout>
      <VideoPlayer ... />
      <EpisodeSelector ... />
      <VideoInfo ... />
      <SkipController ... />
    </PageLayout>
  );
}
```

**ä¸»é¡µé¢åªè´Ÿè´£**:

- è·å– URL å‚æ•°
- ç»„è£… Hooks
- æ¸²æŸ“ç»„ä»¶
- ä¼ é€’ props

---

## ğŸš€ å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆ30 åˆ†é’Ÿï¼‰

1. âœ… åˆ›å»º types æ–‡ä»¶
2. âœ… åˆ›å»º utils æ–‡ä»¶
3. âœ… åˆ›å»ºé”™è¯¯è¾¹ç•Œï¼ˆå·²å®Œæˆï¼‰

### Phase 2: Hooks å±‚ï¼ˆ1 å°æ—¶ï¼‰

4. âœ… useVideoPlayer
5. âœ… usePlaybackHistory
6. âœ… useSourceSelection
7. âœ… useKeyboardShortcuts
8. âœ… useFavorite
9. âœ… useVideoData

### Phase 3: ç»„ä»¶å±‚ï¼ˆ45 åˆ†é’Ÿï¼‰

10. âœ… VideoPlayer ç»„ä»¶
11. âœ… VideoInfo ç»„ä»¶
12. âœ… FavoriteButton ç»„ä»¶
13. âœ… AdFilterLoader

### Phase 4: ä¸»é¡µé¢ï¼ˆ30 åˆ†é’Ÿï¼‰

14. âœ… é‡å†™ PlayPageClient
15. âœ… é›†æˆæ‰€æœ‰æ¨¡å—
16. âœ… æ¸…ç†æ—§ä»£ç 

### Phase 5: æµ‹è¯•éªŒè¯ï¼ˆ30 åˆ†é’Ÿï¼‰

17. âœ… åŠŸèƒ½æµ‹è¯•
18. âœ… ç±»å‹æ£€æŸ¥
19. âœ… æ„å»ºæµ‹è¯•

**é¢„è®¡æ€»æ—¶é—´**: 3-3.5 å°æ—¶

---

## âœ… è´¨é‡æ ‡å‡†

### ä»£ç è´¨é‡

- [ ] æ—  TypeScript é”™è¯¯
- [ ] æ—  ESLint è­¦å‘Š
- [ ] æ‰€æœ‰å‡½æ•°æœ‰ JSDoc æ³¨é‡Š
- [ ] å…³é”®é€»è¾‘æœ‰ä»£ç æ³¨é‡Š

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸
- [ ] æ’­æ”¾å™¨æ­£å¸¸å·¥ä½œ
- [ ] æ¢æºåŠŸèƒ½æ­£å¸¸
- [ ] æ’­æ”¾è®°å½•æ­£å¸¸
- [ ] æ”¶è—åŠŸèƒ½æ­£å¸¸
- [ ] å¿«æ·é”®æ­£å¸¸

### æ€§èƒ½

- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— ä¸å¿…è¦çš„é‡æ¸²æŸ“
- [ ] åŠ è½½é€Ÿåº¦ä¸å˜æ…¢

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š

- âœ… ä»£ç ç»“æ„æ¸…æ™°
- âœ… æ˜“äºç†è§£å’Œä¿®æ”¹
- âœ… ç±»å‹å®‰å…¨ï¼Œå‡å°‘ bug

### é•¿æœŸæ”¶ç›Š

- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âœ… ç»„ä»¶å¯å¤ç”¨
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•
- âœ… æ–°äººå®¹æ˜“ä¸Šæ‰‹
- âœ… Git å†²çªå‡å°‘

### æŠ€æœ¯å€ºåŠ¡

- âœ… æ¶ˆé™¤ 1900 è¡Œå•æ–‡ä»¶
- âœ… æ¶ˆé™¤ any ç±»å‹
- âœ… æ¶ˆé™¤é‡å¤ä»£ç 

---

**å¼€å§‹æ—¶é—´**: 2025-11-12
**é¢„è®¡å®Œæˆ**: 3-3.5 å°æ—¶
**è´Ÿè´£äºº**: Claude Code
