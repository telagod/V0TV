# ğŸ” V0TV æºè§£æå®Œæ•´åˆ†ææŠ¥å‘Š

> æ·±åº¦åˆ†æé¡¹ç›®çš„ API æºè§£ææœºåˆ¶ã€å­˜åœ¨çš„é—®é¢˜åŠä¼˜åŒ–æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [æºè§£ææ¶æ„](#1-æºè§£ææ¶æ„)
2. [æ ¸å¿ƒè§£æé€»è¾‘](#2-æ ¸å¿ƒè§£æé€»è¾‘)
3. [è¯·æ±‚ç®¡ç†æœºåˆ¶](#3-è¯·æ±‚ç®¡ç†æœºåˆ¶)
4. [å‘ç°çš„é—®é¢˜](#4-å‘ç°çš„é—®é¢˜)
5. [ä¼˜åŒ–å»ºè®®](#5-ä¼˜åŒ–å»ºè®®)

---

## 1. æºè§£ææ¶æ„

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶                           | ä½œç”¨           | è¡Œæ•°   |
| ------------------------------ | -------------- | ------ |
| **src/lib/downstream.ts**      | æºè§£ææ ¸å¿ƒé€»è¾‘ | 316 è¡Œ |
| **src/lib/config.ts**          | æºé…ç½®ç®¡ç†     | 492 è¡Œ |
| **src/lib/request-manager.ts** | è¯·æ±‚ç®¡ç†å™¨     | 599 è¡Œ |
| **config.json**                | æºé…ç½®æ–‡ä»¶     | 18 è¡Œ  |

---

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢/è¯¦æƒ…è¯·æ±‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  downstream.ts      â”‚
â”‚  searchFromApi()    â”‚  â† æœç´¢APIè§£æ
â”‚  getDetailFromApi() â”‚  â† è¯¦æƒ…APIè§£æ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  request-manager.ts â”‚
â”‚  - é‡è¯•æœºåˆ¶          â”‚  â† EAI_AGAIN é”™è¯¯å¤„ç†
â”‚  - ç†”æ–­å™¨            â”‚  â† æºå¤±æ•ˆä¿æŠ¤
â”‚  - å¹¶å‘æ§åˆ¶          â”‚  â† é˜²æ­¢è¿‡è½½
â”‚  - ç¼“å­˜              â”‚  â† æ€§èƒ½ä¼˜åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API æºç«™           â”‚
â”‚  (å„ç§èµ„æºAPI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒè§£æé€»è¾‘

### 2.1 æœç´¢è§£æ (`searchFromApi`)

**ä½ç½®**: `src/lib/downstream.ts:19-173`

#### å·¥ä½œæµç¨‹

```
1. æ„å»ºæœç´¢URL
   apiBaseUrl + "?ac=videolist&wd=" + query
   â†“
2. è¯·æ±‚ç¬¬ä¸€é¡µæ•°æ®ï¼ˆé€šè¿‡è¯·æ±‚ç®¡ç†å™¨ï¼‰
   â†“
3. è§£æç¬¬ä¸€é¡µç»“æœ (è¡Œ46-84)
   - æå–M3U8é“¾æ¥
   - ä½¿ç”¨ $$$ åˆ†å‰²å¤šä¸ªæ’­æ”¾æº
   - æ­£åˆ™æå–ï¼š\$(https?://[^"'\s]+?\.m3u8)
   â†“
4. åˆ†é¡µå¤„ç† (è¡Œ86-167)
   - è·å–æ€»é¡µæ•° pagecount
   - å¹¶å‘è¯·æ±‚é¢å¤–é¡µé¢
   - åˆå¹¶æ‰€æœ‰ç»“æœ
   â†“
5. è¿”å›æœç´¢ç»“æœæ•°ç»„
```

#### å…³é”®ä»£ç åˆ†æ

**ç¬¬ä¸€é¡µ M3U8 æå–** (è¡Œ 50-61):

```typescript
if (item.vod_play_url) {
  const m3u8Regex = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
  // âš ï¸ é—®é¢˜ï¼šå…ˆç”¨ $$$ åˆ†å‰²
  const vod_play_url_array = item.vod_play_url.split('$$$');
  // å¯¹æ¯ä¸ªåˆ†ç‰‡åšåŒ¹é…ï¼Œå–åŒ¹é…åˆ°æœ€å¤šçš„ä½œä¸ºç»“æœ
  vod_play_url_array.forEach((url: string) => {
    const matches = url.match(m3u8Regex) || [];
    if (matches.length > episodes.length) {
      episodes = matches;
    }
  });
}
```

**åç»­é¡µ M3U8 æå–** (è¡Œ 122-126):

```typescript
if (item.vod_play_url) {
  const m3u8Regex = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
  // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰ç”¨ $$$ åˆ†å‰²ï¼Œé€»è¾‘ä¸ä¸€è‡´ï¼
  episodes = item.vod_play_url.match(m3u8Regex) || [];
}
```

**æ¸…ç†é“¾æ¥** (è¡Œ 63-67):

```typescript
episodes = Array.from(new Set(episodes)).map((link: string) => {
  link = link.substring(1); // å»æ‰å¼€å¤´çš„ $
  const parenIndex = link.indexOf('(');
  return parenIndex > 0 ? link.substring(0, parenIndex) : link;
});
```

---

### 2.2 è¯¦æƒ…è§£æ (`getDetailFromApi`)

**ä½ç½®**: `src/lib/downstream.ts:178-248`

#### å·¥ä½œæµç¨‹

```
1. æ„å»ºè¯¦æƒ…URL
   apiBaseUrl + "?ac=videolist&ids=" + id
   â†“
2. è¯·æ±‚è¯¦æƒ…æ•°æ®ï¼ˆé€šè¿‡è¯·æ±‚ç®¡ç†å™¨ï¼‰
   â†“
3. è§£ææ’­æ”¾æº (è¡Œ209-225)
   - ä½¿ç”¨ $$$ åˆ†å‰²å¤šä¸ªæ’­æ”¾æº
   - ä½¿ç”¨ # åˆ†å‰²é›†æ•°
   - ä½¿ç”¨ $ åˆ†å‰²é›†åå’ŒURL
   â†“
4. é™çº§å¤„ç† (è¡Œ227-231)
   - å¦‚æœæ’­æ”¾æºä¸ºç©º
   - å°è¯•ä» vod_content ä¸­æå– m3u8
   â†“
5. è¿”å›è¯¦æƒ…å¯¹è±¡
```

#### å…³é”®ä»£ç åˆ†æ

**æ’­æ”¾æºæ‹†åˆ†** (è¡Œ 210-224):

```typescript
if (videoDetail.vod_play_url) {
  // 1. å…ˆç”¨ $$$ åˆ†å‰²å¤šä¸ªæ’­æ”¾æº
  const playSources = videoDetail.vod_play_url.split('$$$');

  if (playSources.length > 0) {
    // 2. åªå–ç¬¬ä¸€ä¸ªæ’­æ”¾æº
    const mainSource = playSources[0];

    // 3. ç”¨ # åˆ†å‰²é›†æ•°
    const episodeList = mainSource.split('#');

    // 4. æå– $ åé¢çš„URL
    episodes = episodeList
      .map((ep: string) => {
        const parts = ep.split('$');
        return parts.length > 1 ? parts[1] : '';
      })
      .filter(
        (url: string) =>
          url && (url.startsWith('http://') || url.startsWith('https://'))
      );
  }
}
```

**é™çº§æå–** (è¡Œ 227-231):

```typescript
// å¦‚æœæ’­æ”¾æºä¸ºç©ºï¼Œåˆ™å°è¯•ä»å†…å®¹ä¸­è§£æ m3u8
if (episodes.length === 0 && videoDetail.vod_content) {
  const matches = videoDetail.vod_content.match(M3U8_PATTERN) || [];
  episodes = matches.map((link: string) => link.replace(/^\$/, ''));
}
```

---

### 2.3 ç‰¹æ®Šæºå¤„ç† (`handleSpecialSourceDetail`)

**ä½ç½®**: `src/lib/downstream.ts:250-315`

#### æ”¯æŒçš„ç‰¹æ®Šæº

å½“å‰åªæ”¯æŒ **ffzy** æºçš„ç‰¹æ®Šå¤„ç†ã€‚

#### å·¥ä½œæµç¨‹

```
1. æ„å»ºè¯¦æƒ…é¡µURL
   detail/index.php/vod/detail/id/{id}.html
   â†“
2. è¯·æ±‚HTMLé¡µé¢
   â†“
3. æ­£åˆ™æå–M3U8é“¾æ¥
   - ä¼˜å…ˆï¼šffzyä¸“ç”¨æ­£åˆ™
   - é™çº§ï¼šé€šç”¨m3u8æ­£åˆ™
   â†“
4. æ­£åˆ™æå–é¡µé¢å…ƒæ•°æ®
   - æ ‡é¢˜ï¼š<h1>...</h1>
   - æè¿°ï¼šclass="sketch"
   - å°é¢ï¼š.jpg é“¾æ¥
   - å¹´ä»½ï¼š>(\d{4})<
   â†“
5. è¿”å›è¯¦æƒ…å¯¹è±¡
```

#### å…³é”®ä»£ç åˆ†æ

**ffzy ä¸“ç”¨æ­£åˆ™** (è¡Œ 266-269):

```typescript
if (apiSite.key === 'ffzy') {
  const ffzyPattern =
    /\$(https?:\/\/[^"'\s]+?\/\d{8}\/\d+_[a-f0-9]+\/index\.m3u8)/g;
  matches = html.match(ffzyPattern) || [];
}
```

**é€šç”¨é™çº§** (è¡Œ 271-275):

```typescript
if (matches.length === 0) {
  const generalPattern = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
  matches = html.match(generalPattern) || [];
}
```

---

## 3. è¯·æ±‚ç®¡ç†æœºåˆ¶

### 3.1 è¯·æ±‚ç®¡ç†å™¨æ¶æ„

**ä½ç½®**: `src/lib/request-manager.ts`

```
RequestManager
â”œâ”€â”€ LRUCache         â† ç¼“å­˜ç®¡ç† (5åˆ†é’ŸTTL)
â”œâ”€â”€ CircuitBreaker   â† ç†”æ–­å™¨ (5æ¬¡å¤±è´¥è§¦å‘)
â”œâ”€â”€ RequestQueue     â† å¹¶å‘æ§åˆ¶ (å…¨å±€5ä¸ªï¼Œæ¯æº2ä¸ª)
â””â”€â”€ fetchWithRetry   â† é‡è¯•æœºåˆ¶ (æŒ‡æ•°é€€é¿)
```

---

### 3.2 é‡è¦é…ç½®

| é…ç½®é¡¹                        | é»˜è®¤å€¼ | è¯´æ˜               |
| ----------------------------- | ------ | ------------------ |
| **MAX_CONCURRENT_REQUESTS**   | 5      | å…¨å±€æœ€å¤§å¹¶å‘æ•°     |
| **MAX_CONCURRENT_PER_HOST**   | 2      | æ¯ä¸ªåŸŸåæœ€å¤§å¹¶å‘æ•° |
| **MAX_RETRIES**               | 3      | æœ€å¤§é‡è¯•æ¬¡æ•°       |
| **INITIAL_RETRY_DELAY**       | 1000ms | åˆå§‹é‡è¯•å»¶è¿Ÿ       |
| **RETRY_BACKOFF_MULTIPLIER**  | 2      | æŒ‡æ•°é€€é¿å€æ•°       |
| **CIRCUIT_BREAKER_THRESHOLD** | 5      | ç†”æ–­é˜ˆå€¼           |
| **CIRCUIT_BREAKER_TIMEOUT**   | 60s    | ç†”æ–­æ¢å¤æ—¶é—´       |
| **CACHE_TTL**                 | 5 åˆ†é’Ÿ | ç¼“å­˜ç”Ÿå­˜æ—¶é—´       |

---

### 3.3 é”™è¯¯å¤„ç†

**å¯é‡è¯•é”™è¯¯** (è¡Œ 309-317):

```typescript
retryableErrors: [
  'ECONNRESET', // è¿æ¥é‡ç½®
  'ETIMEDOUT', // è¶…æ—¶
  'ENOTFOUND', // DNSæœªæ‰¾åˆ°
  'EAI_AGAIN', // âœ… DNSä¸´æ—¶å¤±è´¥ï¼ˆä½ é‡åˆ°çš„é”™è¯¯ï¼‰
  'ECONNREFUSED', // è¿æ¥è¢«æ‹’ç»
  'NetworkError', // ç½‘ç»œé”™è¯¯
  'AbortError', // è¯·æ±‚ä¸­æ­¢
];
```

---

## 4. å‘ç°çš„é—®é¢˜

### ğŸš¨ é«˜ä¼˜å…ˆçº§é—®é¢˜

#### é—®é¢˜ 1ï¼šæœç´¢è§£æé€»è¾‘ä¸ä¸€è‡´

**ä½ç½®**: `src/lib/downstream.ts:54-60` vs `è¡Œ122-126`

**é—®é¢˜æè¿°**:

- ç¬¬ä¸€é¡µï¼šä½¿ç”¨ `$$$` åˆ†å‰²æ’­æ”¾æºï¼Œå–åŒ¹é…æœ€å¤šçš„
- åç»­é¡µï¼šç›´æ¥å¯¹æ•´ä¸ªå­—ç¬¦ä¸²æ­£åˆ™åŒ¹é…

**å®é™…æµ‹è¯•**:

```bash
# æµ‹è¯•æºï¼šhttp://caiji.dyttzyapi.com/api.php/provide/vod
# å®é™…æ•°æ®æ ¼å¼ï¼š
"vod_play_from": "dytt$$$dyttm3u8"
"vod_play_url": "ç¬¬01é›†$URL1#ç¬¬02é›†$URL2$$$ç¬¬01é›†$URL1#ç¬¬02é›†$URL2"
```

**å½±å“**:

- åç»­é¡µå¯èƒ½æå–åˆ°é”™è¯¯çš„æ’­æ”¾æº
- ä¸åŒåˆ†é¡µç»“æœä¸ä¸€è‡´
- å¯èƒ½å¯¼è‡´æ’­æ”¾å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// ç»Ÿä¸€ä½¿ç”¨è¿™ä¸ªé€»è¾‘ï¼ˆç¬¬ä¸€é¡µçš„é€»è¾‘ï¼‰
if (item.vod_play_url) {
  const m3u8Regex = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
  const vod_play_url_array = item.vod_play_url.split('$$$');
  vod_play_url_array.forEach((url: string) => {
    const matches = url.match(m3u8Regex) || [];
    if (matches.length > episodes.length) {
      episodes = matches;
    }
  });
}
```

---

#### é—®é¢˜ 2ï¼šM3U8 æ­£åˆ™è¿‡äºå®½æ³›

**ä½ç½®**: `src/lib/downstream.ts:51` å’Œ `è¡Œ176`

**é—®é¢˜æè¿°**:
å½“å‰æ­£åˆ™ï¼š`/\$(https?:\/\/[^"'\s]+?\.m3u8)/g`

è¿™ä¸ªæ­£åˆ™ä¼šåŒ¹é…**æ‰€æœ‰ä»¥ .m3u8 ç»“å°¾çš„ URL**ï¼Œä½†å®é™…ä¸Šï¼š

**æµ‹è¯•å‘ç°çš„é—®é¢˜**:

```json
{
  "vod_play_url": "ç¬¬01é›†$https://vip.dytt-cinema.com/share/020bf2c4..."
}
```

è¿™ä¸ª URL **ä¸æ˜¯** m3u8 æ–‡ä»¶ï¼Œè€Œæ˜¯**é‡å®šå‘é¡µé¢**ï¼

**å®é™…çš„ M3U8 é“¾æ¥æ ¼å¼**ï¼ˆä»ç¬¬äºŒä¸ªæ’­æ”¾æºæå–ï¼‰:

```
https://vip.dytt-cinema.com/20250215/2419_020bf2c4/index.m3u8
```

**å½±å“**:

- å½“å‰ä»£ç ä¼šé”™è¯¯åœ°æå– `/share/...` é“¾æ¥
- è¿™äº›é“¾æ¥ä¸æ˜¯ç›´æ¥çš„ m3u8 æ–‡ä»¶
- æ’­æ”¾æ—¶ä¼šå¤±è´¥æˆ–éœ€è¦é¢å¤–è·³è½¬

**æ­£ç¡®å¤„ç†æ–¹æ¡ˆ**:

```typescript
// 1. ä¼˜å…ˆæå–æ ‡å‡†m3u8é“¾æ¥
const standardM3u8Regex = /https?:\/\/[^"'\s]+?\/\d{8,}\/[^\/]+\/index\.m3u8/g;

// 2. å¦‚æœæ²¡æœ‰ï¼Œæ‰æå– .m3u8 ç»“å°¾çš„
const generalM3u8Regex = /https?:\/\/[^"'\s]+?\.m3u8/g;

// 3. è¿‡æ»¤æ‰ /share/ è·¯å¾„
const filteredEpisodes = episodes.filter((url) => !url.includes('/share/'));
```

---

#### é—®é¢˜ 3ï¼šåªå–ç¬¬ä¸€ä¸ªæ’­æ”¾æº

**ä½ç½®**: `src/lib/downstream.ts:213`

**é—®é¢˜æè¿°**:

```typescript
// åªå–ç¬¬ä¸€ä¸ªæ’­æ”¾æº
const mainSource = playSources[0];
```

**æµ‹è¯•æ•°æ®**:

```json
{
  "vod_play_from": "dytt$$$dyttm3u8",
  "vod_play_url": "dyttæºæ•°æ®$$$m3u8æºæ•°æ®"
}
```

- **dytt æº**: é‡å®šå‘é“¾æ¥ï¼ˆå¦‚ `/share/...`ï¼‰
- **dyttm3u8 æº**: çœŸå® m3u8 é“¾æ¥

**å½±å“**:

- å½“å‰ä»£ç åªå–ç¬¬ä¸€ä¸ªæºï¼ˆdyttï¼‰ï¼Œä¼šè·å–åˆ°é”™è¯¯çš„é“¾æ¥æ ¼å¼
- ç¬¬äºŒä¸ªæºï¼ˆdyttm3u8ï¼‰æ‰æ˜¯çœŸæ­£çš„æ’­æ”¾é“¾æ¥ï¼Œè¢«å¿½ç•¥äº†

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// è§£ææ‰€æœ‰æ’­æ”¾æºï¼Œè¿”å›å¤šä¸ªæ’­æ”¾æºåˆ—è¡¨
const allPlaySources: { [key: string]: string[] } = {};

if (videoDetail.vod_play_url && videoDetail.vod_play_from) {
  const playSources = videoDetail.vod_play_url.split('$$$');
  const sourceNames = videoDetail.vod_play_from.split('$$$');

  playSources.forEach((source, index) => {
    const sourceName = sourceNames[index] || `æº${index + 1}`;
    const episodeList = source.split('#');

    const episodes = episodeList
      .map((ep: string) => {
        const parts = ep.split('$');
        return parts.length > 1 ? parts[1] : '';
      })
      .filter(
        (url) =>
          url &&
          (url.startsWith('http://') || url.startsWith('https://')) &&
          url.endsWith('.m3u8') // åªè¦çœŸæ­£çš„m3u8
      );

    if (episodes.length > 0) {
      allPlaySources[sourceName] = episodes;
    }
  });
}

// ä¼˜å…ˆé€‰æ‹©åŒ…å« m3u8 å…³é”®è¯çš„æº
let episodes: string[] = [];
if (allPlaySources['dyttm3u8']) {
  episodes = allPlaySources['dyttm3u8'];
} else if (allPlaySources['m3u8']) {
  episodes = allPlaySources['m3u8'];
} else {
  // å–ç¬¬ä¸€ä¸ªå¯ç”¨æº
  episodes = Object.values(allPlaySources)[0] || [];
}
```

---

#### é—®é¢˜ 4ï¼šç‰¹æ®Šæºæ”¯æŒå¤ªå°‘

**ä½ç½®**: `src/lib/downstream.ts:266`

**é—®é¢˜æè¿°**:
å½“å‰åªæ”¯æŒ **ffzy** ä¸€ä¸ªç‰¹æ®Šæºã€‚

**å®é™…æƒ…å†µ**:

- å¾ˆå¤šæºéƒ½ä½¿ç”¨ç‰¹æ®Šçš„ detail é¡µé¢æ ¼å¼
- éœ€è¦æ”¯æŒæ›´å¤šå¸¸è§æºç«™

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// æ‰©å±•ç‰¹æ®Šæºå¤„ç†
const specialSourceHandlers: { [key: string]: RegExp } = {
  ffzy: /\$(https?:\/\/[^"'\s]+?\/\d{8}\/\d+_[a-f0-9]+\/index\.m3u8)/g,
  ckzy: /\$(https?:\/\/[^"'\s]+?\/\d{8}\/[^\/]+\/index\.m3u8)/g,
  // æ·»åŠ æ›´å¤šæº...
};

if (apiSite.key in specialSourceHandlers) {
  matches = html.match(specialSourceHandlers[apiSite.key]) || [];
}
```

---

### âš ï¸ ä¸­ä¼˜å…ˆçº§é—®é¢˜

#### é—®é¢˜ 5ï¼šç¼ºå°‘ URL éªŒè¯

**ä½ç½®**: `src/lib/downstream.ts:222-223`

**é—®é¢˜æè¿°**:

```typescript
.filter(
  (url: string) =>
    url && (url.startsWith('http://') || url.startsWith('https://'))
);
```

åªéªŒè¯äº†åè®®ï¼Œæ²¡æœ‰éªŒè¯ï¼š

- URL æ ¼å¼æ˜¯å¦æ­£ç¡®
- æ˜¯å¦æ˜¯çœŸæ­£çš„ m3u8 æ–‡ä»¶
- åŸŸåæ˜¯å¦å¯è®¿é—®

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
function isValidM3u8Url(url: string): boolean {
  try {
    const urlObj = new URL(url);

    // 1. æ£€æŸ¥åè®®
    if (!['http:', 'https:'].includes(urlObj.protocol)) {
      return false;
    }

    // 2. æ£€æŸ¥æ‰©å±•å
    if (!urlObj.pathname.endsWith('.m3u8')) {
      return false;
    }

    // 3. æ’é™¤å·²çŸ¥çš„ä¸­è½¬é¡µé¢è·¯å¾„
    const excludePaths = ['/share/', '/redirect/', '/jump/'];
    if (excludePaths.some(path => urlObj.pathname.includes(path))) {
      return false;
    }

    // 4. æ£€æŸ¥åŸŸåæ ¼å¼
    if (!urlObj.hostname) {
      return false;
    }

    return true;
  } catch {
    return false;
  }
}

// ä½¿ç”¨
.filter((url: string) => isValidM3u8Url(url))
```

---

#### é—®é¢˜ 6ï¼šå¹´ä»½æå–ä¸å¯é 

**ä½ç½®**: `src/lib/downstream.ts:77-79`

**é—®é¢˜æè¿°**:

```typescript
year: item.vod_year
  ? item.vod_year.match(/\d{4}/)?.[0] || ''
  : 'unknown',
```

**æµ‹è¯•æ•°æ®**:

```json
{
  "vod_year": "2024" // âœ… æ­£å¸¸
}
```

ä½†æœ‰äº›æºå¯èƒ½è¿”å›ï¼š

- `"2024-2025"` â†’ æå–ä¸º `"2024"`ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰
- `"24å¹´"` â†’ æå–å¤±è´¥
- `null` â†’ è®¾ä¸º `"unknown"`

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
function extractYear(vodYear: string | null | undefined): string {
  if (!vodYear) return '';

  // 1. æå–æ‰€æœ‰4ä½æ•°å­—
  const years = vodYear.match(/\d{4}/g);
  if (!years || years.length === 0) return '';

  // 2. å¦‚æœæœ‰å¤šä¸ªå¹´ä»½ï¼Œå–æœ€è¿‘çš„
  const validYears = years
    .map(y => parseInt(y))
    .filter(y => y >= 1900 && y <= new Date().getFullYear() + 1);

  if (validYears.length === 0) return '';

  // 3. è¿”å›æœ€å¤§å¹´ä»½ï¼ˆæœ€æ–°ï¼‰
  return Math.max(...validYears).toString();
}

// ä½¿ç”¨
year: extractYear(item.vod_year),
```

---

#### é—®é¢˜ 7ï¼šç¼ºå°‘æ’­æ”¾æºåç§°

**ä½ç½®**: `src/lib/downstream.ts:69-84`

**é—®é¢˜æè¿°**:
å½“å‰è¿”å›çš„ç»“æœæ²¡æœ‰åŒ…å«æ’­æ”¾æºåç§°ï¼ˆå¦‚ "dytt", "dyttm3u8"ï¼‰ã€‚

**å½±å“**:

- å‰ç«¯æ— æ³•æ˜¾ç¤ºå¤šä¸ªæ’­æ”¾æºä¾›ç”¨æˆ·é€‰æ‹©
- æ— æ³•çŸ¥é“å“ªä¸ªæºæ›´ä¼˜è´¨

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
interface SearchResult {
  id: string;
  title: string;
  poster: string;

  // âœ… æ”¹ä¸ºå¯¹è±¡ï¼Œæ”¯æŒå¤šæ’­æ”¾æº
  playSources: {
    [sourceName: string]: string[];
  };

  // æˆ–è€…ä½¿ç”¨æ•°ç»„
  playSources: Array<{
    name: string;
    episodes: string[];
    priority: number; // ä¼˜å…ˆçº§
  }>;

  source: string;
  source_name: string;
  // ...
}
```

---

### ğŸ’¡ ä½ä¼˜å…ˆçº§é—®é¢˜

#### é—®é¢˜ 8ï¼šç¼ºå°‘é”™è¯¯æ—¥å¿—ä¸Šä¸‹æ–‡

**ä½ç½®**: `src/lib/downstream.ts:170-172`

**é—®é¢˜æè¿°**:

```typescript
} catch (error) {
  return [];
}
```

**å½±å“**:

- è§£æå¤±è´¥æ—¶ï¼Œæ— æ³•çŸ¥é“åŸå› 
- éš¾ä»¥è°ƒè¯•é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
} catch (error) {
  console.error(`[æºè§£æ] ${apiSite.name} æœç´¢å¤±è´¥:`, {
    query,
    error: error instanceof Error ? error.message : error,
    apiUrl: apiBaseUrl,
  });
  return [];
}
```

---

#### é—®é¢˜ 9ï¼šé‡å¤ä»£ç è¿‡å¤š

**ä½ç½®**: æ•´ä¸ª `downstream.ts` æ–‡ä»¶

**é—®é¢˜æè¿°**:

- M3U8 æå–é€»è¾‘é‡å¤äº† 3 æ¬¡ï¼ˆæœç´¢ç¬¬ä¸€é¡µã€æœç´¢åç»­é¡µã€è¯¦æƒ…é¡µï¼‰
- é“¾æ¥æ¸…ç†é€»è¾‘é‡å¤äº† 2 æ¬¡

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// æå–ä¸ºç‹¬ç«‹å‡½æ•°
function extractM3u8FromPlayUrl(playUrl: string): string[] {
  const m3u8Regex = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
  const vod_play_url_array = playUrl.split('$$$');

  let episodes: string[] = [];
  vod_play_url_array.forEach((url: string) => {
    const matches = url.match(m3u8Regex) || [];
    if (matches.length > episodes.length) {
      episodes = matches;
    }
  });

  // å»é‡å’Œæ¸…ç†
  return Array.from(new Set(episodes)).map((link: string) => {
    link = link.substring(1); // å»æ‰å¼€å¤´çš„ $
    const parenIndex = link.indexOf('(');
    return parenIndex > 0 ? link.substring(0, parenIndex) : link;
  });
}

// ç»Ÿä¸€ä½¿ç”¨
episodes = extractM3u8FromPlayUrl(item.vod_play_url || '');
```

---

#### é—®é¢˜ 10ï¼šç¼ºå°‘æ€§èƒ½ç›‘æ§

**ä½ç½®**: æ•´ä¸ªè¯·æ±‚æµç¨‹

**é—®é¢˜æè¿°**:

- æ²¡æœ‰è®°å½•æ¯ä¸ªæºçš„å“åº”æ—¶é—´
- æ²¡æœ‰ç»Ÿè®¡è§£ææˆåŠŸç‡
- æ— æ³•è¯†åˆ«æ…¢æº

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// æ·»åŠ æ€§èƒ½ç›‘æ§
interface SourceMetrics {
  sourceName: string;
  requestCount: number;
  successCount: number;
  failureCount: number;
  avgResponseTime: number;
  lastError?: string;
}

const sourceMetrics = new Map<string, SourceMetrics>();

async function searchFromApiWithMetrics(
  apiSite: ApiSite,
  query: string
): Promise<SearchResult[]> {
  const startTime = Date.now();

  try {
    const results = await searchFromApi(apiSite, query);

    // è®°å½•æˆåŠŸ
    const duration = Date.now() - startTime;
    updateMetrics(apiSite.name, true, duration);

    return results;
  } catch (error) {
    // è®°å½•å¤±è´¥
    const duration = Date.now() - startTime;
    updateMetrics(apiSite.name, false, duration, error);

    throw error;
  }
}
```

---

## 5. ä¼˜åŒ–å»ºè®®

### ğŸ¯ é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

#### ä¼˜åŒ– 1ï¼šç»Ÿä¸€ M3U8 æå–é€»è¾‘

**ç›®æ ‡**: ä¿®å¤ç¬¬ä¸€é¡µå’Œåç»­é¡µè§£æä¸ä¸€è‡´çš„é—®é¢˜

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºç»Ÿä¸€çš„æå–å‡½æ•°

```typescript
/**
 * ä» vod_play_url ä¸­æå– M3U8 é“¾æ¥
 * @param vodPlayUrl - APIè¿”å›çš„æ’­æ”¾URLå­—ç¬¦ä¸²
 * @param vodPlayFrom - æ’­æ”¾æºåç§°ï¼ˆå¯é€‰ï¼‰
 * @returns æå–çš„M3U8é“¾æ¥æ•°ç»„
 */
function extractM3u8Links(vodPlayUrl: string, vodPlayFrom?: string): string[] {
  if (!vodPlayUrl) return [];

  // 1. å…ˆç”¨ $$$ åˆ†å‰²å¤šä¸ªæ’­æ”¾æº
  const playSources = vodPlayUrl.split('$$$');
  const sourceNames = vodPlayFrom?.split('$$$') || [];

  let bestEpisodes: string[] = [];
  let bestSourceName = '';

  // 2. éå†æ¯ä¸ªæ’­æ”¾æº
  playSources.forEach((source, index) => {
    const sourceName = sourceNames[index] || `æº${index + 1}`;

    // 3. æå–M3U8é“¾æ¥
    // ä¼˜å…ˆä½¿ç”¨ä¸¥æ ¼çš„æ­£åˆ™ï¼ˆæ’é™¤/share/ç­‰ä¸­è½¬é¡µé¢ï¼‰
    const strictRegex = /\$(https?:\/\/[^"'\s]+?\/\d{8,}[^"'\s]*?\.m3u8)/g;
    let matches = source.match(strictRegex) || [];

    // é™çº§ï¼šä½¿ç”¨å®½æ¾çš„æ­£åˆ™
    if (matches.length === 0) {
      const looseRegex = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
      matches = source.match(looseRegex) || [];
    }

    // 4. æ¸…ç†é“¾æ¥
    const episodes = matches.map((link: string) => {
      link = link.substring(1); // å»æ‰å¼€å¤´çš„ $
      const parenIndex = link.indexOf('(');
      return parenIndex > 0 ? link.substring(0, parenIndex) : link;
    });

    // 5. è¿‡æ»¤æ— æ•ˆé“¾æ¥
    const validEpisodes = episodes.filter((url) => isValidM3u8Url(url));

    // 6. é€‰æ‹©æœ€ä¼˜æ’­æ”¾æº
    // ä¼˜å…ˆçº§ï¼šm3u8 > dyttm3u8 > å…¶ä»–
    if (
      validEpisodes.length > bestEpisodes.length ||
      (sourceName.includes('m3u8') && !bestSourceName.includes('m3u8'))
    ) {
      bestEpisodes = validEpisodes;
      bestSourceName = sourceName;
    }
  });

  // 7. å»é‡
  return Array.from(new Set(bestEpisodes));
}
```

2. åœ¨æœç´¢å’Œè¯¦æƒ…è§£æä¸­ç»Ÿä¸€ä½¿ç”¨

```typescript
// æœç´¢ç¬¬ä¸€é¡µ
const results = data.list.map((item: ApiSearchItem) => {
  const episodes = extractM3u8Links(
    item.vod_play_url || '',
    item.vod_play_from
  );

  return {
    id: item.vod_id.toString(),
    title: item.vod_name.trim(),
    episodes,
    // ...
  };
});

// æœç´¢åç»­é¡µï¼ˆåŒæ ·çš„é€»è¾‘ï¼‰
return pageData.list.map((item: ApiSearchItem) => {
  const episodes = extractM3u8Links(
    item.vod_play_url || '',
    item.vod_play_from
  );

  return {
    id: item.vod_id.toString(),
    title: item.vod_name.trim(),
    episodes,
    // ...
  };
});
```

**é¢„æœŸæ•ˆæœ**:

- âœ… æ‰€æœ‰é¡µé¢è§£æé€»è¾‘ä¸€è‡´
- âœ… è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ’­æ”¾æº
- âœ… è¿‡æ»¤æ— æ•ˆé“¾æ¥
- âœ… ä»£ç å¯ç»´æŠ¤æ€§æå‡

---

#### ä¼˜åŒ– 2ï¼šæ”¯æŒå¤šæ’­æ”¾æº

**ç›®æ ‡**: å…è®¸ç”¨æˆ·åœ¨å¤šä¸ªæ’­æ”¾æºä¹‹é—´åˆ‡æ¢

**å®æ–½æ­¥éª¤**:

1. ä¿®æ”¹æ•°æ®ç»“æ„

```typescript
// src/lib/types.ts

export interface PlaySource {
  name: string; // æ’­æ”¾æºåç§°ï¼ˆdytt, dyttm3u8ç­‰ï¼‰
  episodes: string[]; // é›†æ•°åˆ—è¡¨
  priority: number; // ä¼˜å…ˆçº§ï¼ˆ1æœ€é«˜ï¼‰
  quality?: string; // ç”»è´¨ï¼ˆå¦‚æœAPIæä¾›ï¼‰
}

export interface SearchResult {
  id: string;
  title: string;
  poster: string;

  // âœ… æ”¹ä¸ºæ”¯æŒå¤šæ’­æ”¾æº
  playSources: PlaySource[];

  // ä¿ç•™ä¸»æ’­æ”¾æºï¼ˆå‘åå…¼å®¹ï¼‰
  episodes: string[];

  source: string;
  source_name: string;
  class?: string;
  year?: string;
  desc?: string;
  type_name?: string;
  douban_id?: number;
}
```

2. ä¿®æ”¹è§£æé€»è¾‘

```typescript
function parseAllPlaySources(
  vodPlayUrl: string,
  vodPlayFrom?: string
): PlaySource[] {
  if (!vodPlayUrl) return [];

  const playSources = vodPlayUrl.split('$$$');
  const sourceNames = vodPlayFrom?.split('$$$') || [];

  const results: PlaySource[] = [];

  playSources.forEach((source, index) => {
    const sourceName = sourceNames[index] || `æ’­æ”¾æº${index + 1}`;

    // è§£æé›†æ•°
    const episodeList = source.split('#');
    const episodes = episodeList
      .map((ep: string) => {
        const parts = ep.split('$');
        return parts.length > 1 ? parts[1] : '';
      })
      .filter((url) => isValidM3u8Url(url));

    if (episodes.length > 0) {
      // è®¡ç®—ä¼˜å…ˆçº§
      let priority = 99;
      if (sourceName.includes('m3u8')) priority = 1; // M3U8æºä¼˜å…ˆ
      else if (sourceName.includes('é«˜æ¸…')) priority = 2;
      else if (sourceName.includes('æ ‡æ¸…')) priority = 3;

      results.push({
        name: sourceName,
        episodes,
        priority,
      });
    }
  });

  // æŒ‰ä¼˜å…ˆçº§æ’åº
  return results.sort((a, b) => a.priority - b.priority);
}
```

3. è¿”å›å®Œæ•´æ’­æ”¾æºåˆ—è¡¨

```typescript
const playSources = parseAllPlaySources(
  item.vod_play_url || '',
  item.vod_play_from
);

return {
  id: item.vod_id.toString(),
  title: item.vod_name.trim(),
  playSources,
  // ä¸»æ’­æ”¾æºï¼ˆç¬¬ä¸€ä¸ª/ä¼˜å…ˆçº§æœ€é«˜çš„ï¼‰
  episodes: playSources[0]?.episodes || [],
  // ...
};
```

**é¢„æœŸæ•ˆæœ**:

- âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©å¤šä¸ªæ’­æ”¾æº
- âœ… è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æº
- âœ… æŸä¸ªæºå¤±æ•ˆæ—¶å¯åˆ‡æ¢å¤‡ç”¨æº
- âœ… æå‡æ’­æ”¾æˆåŠŸç‡

---

#### ä¼˜åŒ– 3ï¼šå¢å¼º URL éªŒè¯

**ç›®æ ‡**: è¿‡æ»¤æ— æ•ˆé“¾æ¥ï¼Œæé«˜æ’­æ”¾æˆåŠŸç‡

**å®æ–½æ­¥éª¤**:

1. åˆ›å»º URL éªŒè¯å‡½æ•°

```typescript
/**
 * éªŒè¯M3U8 URLæ˜¯å¦æœ‰æ•ˆ
 */
function isValidM3u8Url(url: string): boolean {
  if (!url) return false;

  try {
    const urlObj = new URL(url);

    // 1. æ£€æŸ¥åè®®
    if (!['http:', 'https:'].includes(urlObj.protocol)) {
      console.warn(`[URLéªŒè¯] æ— æ•ˆåè®®: ${url}`);
      return false;
    }

    // 2. æ£€æŸ¥æ‰©å±•å
    if (!urlObj.pathname.toLowerCase().endsWith('.m3u8')) {
      console.warn(`[URLéªŒè¯] éM3U8æ–‡ä»¶: ${url}`);
      return false;
    }

    // 3. æ’é™¤å·²çŸ¥çš„ä¸­è½¬é¡µé¢è·¯å¾„
    const excludePaths = [
      '/share/', // åˆ†äº«é¡µé¢
      '/redirect/', // é‡å®šå‘é¡µé¢
      '/jump/', // è·³è½¬é¡µé¢
      '/play/', // æ’­æ”¾å™¨é¡µé¢ï¼ˆHTMLï¼‰
      '/player/', // æ’­æ”¾å™¨é¡µé¢ï¼ˆHTMLï¼‰
    ];

    if (excludePaths.some((path) => urlObj.pathname.includes(path))) {
      console.warn(`[URLéªŒè¯] ä¸­è½¬é¡µé¢: ${url}`);
      return false;
    }

    // 4. æ£€æŸ¥åŸŸåæ ¼å¼
    if (!urlObj.hostname || urlObj.hostname === 'localhost') {
      console.warn(`[URLéªŒè¯] æ— æ•ˆåŸŸå: ${url}`);
      return false;
    }

    // 5. æ£€æŸ¥è·¯å¾„æ ¼å¼ï¼ˆæ¨èæ ¼å¼ï¼š/YYYYMMDD/xxx/index.m3u8ï¼‰
    const hasDatePath = /\/\d{8,}\//.test(urlObj.pathname);
    if (!hasDatePath) {
      // è­¦å‘Šä½†ä¸æ‹’ç»ï¼ˆå¯èƒ½æ˜¯å…¶ä»–æ ¼å¼ï¼‰
      console.log(`[URLéªŒè¯] éæ ‡å‡†è·¯å¾„æ ¼å¼: ${url}`);
    }

    return true;
  } catch (error) {
    console.error(`[URLéªŒè¯] è§£æå¤±è´¥: ${url}`, error);
    return false;
  }
}
```

2. åœ¨æ‰€æœ‰æå– M3U8 çš„åœ°æ–¹ä½¿ç”¨

```typescript
// è¿‡æ»¤æ— æ•ˆé“¾æ¥
const validEpisodes = episodes.filter((url) => isValidM3u8Url(url));

if (validEpisodes.length === 0) {
  console.warn(`[æºè§£æ] ${apiSite.name} æ²¡æœ‰æå–åˆ°æœ‰æ•ˆçš„M3U8é“¾æ¥`);
}

return validEpisodes;
```

**é¢„æœŸæ•ˆæœ**:

- âœ… è¿‡æ»¤æ‰ä¸­è½¬é¡µé¢é“¾æ¥
- âœ… åªä¿ç•™çœŸæ­£çš„ M3U8 æ–‡ä»¶
- âœ… å‡å°‘æ’­æ”¾å¤±è´¥ç‡
- âœ… æä¾›è¯¦ç»†çš„éªŒè¯æ—¥å¿—

---

### âš™ï¸ ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

#### ä¼˜åŒ– 4ï¼šæ‰©å±•ç‰¹æ®Šæºæ”¯æŒ

**ç›®æ ‡**: æ”¯æŒæ›´å¤šç‰¹æ®Šæ ¼å¼çš„æºç«™

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºç‰¹æ®Šæºé…ç½®

```typescript
// src/lib/downstream-special-sources.ts

interface SpecialSourceHandler {
  key: string;
  name: string;
  m3u8Pattern: RegExp;
  detailUrlTemplate?: string;
  titlePattern?: RegExp;
  coverPattern?: RegExp;
  descPattern?: RegExp;
}

export const SPECIAL_SOURCE_HANDLERS: SpecialSourceHandler[] = [
  {
    key: 'ffzy',
    name: 'éå‡¡èµ„æº',
    m3u8Pattern: /\$(https?:\/\/[^"'\s]+?\/\d{8}\/\d+_[a-f0-9]+\/index\.m3u8)/g,
    detailUrlTemplate: '{detail}/index.php/vod/detail/id/{id}.html',
  },
  {
    key: 'ckzy',
    name: 'é‡‡é›†èµ„æº',
    m3u8Pattern: /\$(https?:\/\/[^"'\s]+?\/\d{8}\/[^\/]+\/index\.m3u8)/g,
    detailUrlTemplate: '{detail}/index.php/vod/detail/id/{id}.html',
  },
  {
    key: 'lzzy',
    name: 'é‡å­èµ„æº',
    m3u8Pattern: /\$(https?:\/\/[^"'\s]+?\/[\d_]+\/[^\/]+\.m3u8)/g,
    detailUrlTemplate: '{detail}/vod/detail/id/{id}.html',
  },
  // æ·»åŠ æ›´å¤šæº...
];
```

2. ä½¿ç”¨é…ç½®å¤„ç†ç‰¹æ®Šæº

```typescript
async function handleSpecialSourceDetail(
  id: string,
  apiSite: ApiSite
): Promise<SearchResult> {
  // æŸ¥æ‰¾å¯¹åº”çš„ç‰¹æ®Šæºå¤„ç†å™¨
  const handler = SPECIAL_SOURCE_HANDLERS.find((h) => h.key === apiSite.key);

  if (!handler) {
    throw new Error(`ä¸æ”¯æŒçš„ç‰¹æ®Šæº: ${apiSite.key}`);
  }

  // æ„å»ºè¯¦æƒ…URL
  const detailUrl =
    handler.detailUrlTemplate
      ?.replace('{detail}', apiSite.detail || '')
      .replace('{id}', id) || apiSite.detail!;

  // è·å–HTML
  const html = await requestManager.fetch<string>(detailUrl, {
    headers: API_CONFIG.detail.headers,
    timeout: 10000,
    retryOptions: { maxRetries: 2 },
  });

  // ä½¿ç”¨é…ç½®çš„æ­£åˆ™æå–M3U8
  let matches = html.match(handler.m3u8Pattern) || [];

  // é™çº§ï¼šä½¿ç”¨é€šç”¨æ­£åˆ™
  if (matches.length === 0) {
    const generalPattern = /\$(https?:\/\/[^"'\s]+?\.m3u8)/g;
    matches = html.match(generalPattern) || [];
  }

  // æ¸…ç†é“¾æ¥
  matches = Array.from(new Set(matches)).map((link: string) => {
    link = link.substring(1);
    const parenIndex = link.indexOf('(');
    return parenIndex > 0 ? link.substring(0, parenIndex) : link;
  });

  // æå–å…ƒæ•°æ®ï¼ˆä½¿ç”¨é€šç”¨æ­£åˆ™æˆ–é…ç½®çš„æ­£åˆ™ï¼‰
  const titleMatch = html.match(
    handler.titlePattern || /<h1[^>]*>([^<]+)<\/h1>/
  );
  const descMatch = html.match(
    handler.descPattern ||
      /<div[^>]*class=["']sketch["'][^>]*>([\s\S]*?)<\/div>/
  );
  const coverMatch = html.match(
    handler.coverPattern || /(https?:\/\/[^"'\s]+?\.jpg)/g
  );
  const yearMatch = html.match(/>(\d{4})</);

  return {
    id,
    title: titleMatch ? titleMatch[1].trim() : '',
    poster: coverMatch ? coverMatch[0].trim() : '',
    playSources: [{ name: apiSite.name, episodes: matches, priority: 1 }],
    episodes: matches,
    source: apiSite.key,
    source_name: apiSite.name,
    class: '',
    year: yearMatch ? yearMatch[1] : '',
    desc: descMatch ? cleanHtmlTags(descMatch[1]) : '',
    type_name: '',
    douban_id: 0,
  };
}
```

**é¢„æœŸæ•ˆæœ**:

- âœ… è½»æ¾æ·»åŠ æ–°çš„ç‰¹æ®Šæº
- âœ… é…ç½®åŒ–ç®¡ç†ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- âœ… æ”¯æŒæ›´å¤šæºç«™

---

#### ä¼˜åŒ– 5ï¼šæ·»åŠ è§£æé”™è¯¯æ—¥å¿—

**ç›®æ ‡**: ä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºæ—¥å¿—å·¥å…·

```typescript
// src/lib/logger.ts

export enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3,
}

class Logger {
  private level: LogLevel;

  constructor(level: LogLevel = LogLevel.INFO) {
    this.level = level;
  }

  debug(module: string, message: string, data?: any) {
    if (this.level <= LogLevel.DEBUG) {
      console.debug(`[${module}] ${message}`, data || '');
    }
  }

  info(module: string, message: string, data?: any) {
    if (this.level <= LogLevel.INFO) {
      console.log(`[${module}] ${message}`, data || '');
    }
  }

  warn(module: string, message: string, data?: any) {
    if (this.level <= LogLevel.WARN) {
      console.warn(`[${module}] ${message}`, data || '');
    }
  }

  error(module: string, message: string, error?: any) {
    if (this.level <= LogLevel.ERROR) {
      console.error(`[${module}] ${message}`, {
        error: error instanceof Error ? error.message : error,
        stack: error instanceof Error ? error.stack : undefined,
      });
    }
  }
}

export const logger = new Logger(
  process.env.NODE_ENV === 'development' ? LogLevel.DEBUG : LogLevel.INFO
);
```

2. åœ¨è§£æé€»è¾‘ä¸­ä½¿ç”¨

```typescript
export async function searchFromApi(
  apiSite: ApiSite,
  query: string
): Promise<SearchResult[]> {
  const startTime = Date.now();

  try {
    logger.info('æºè§£æ', `å¼€å§‹æœç´¢: ${apiSite.name}`, { query });

    const apiUrl =
      apiSite.api + API_CONFIG.search.path + encodeURIComponent(query);

    const data = await requestManager.fetch<any>(apiUrl, {
      headers: API_CONFIG.search.headers,
      timeout: 8000,
      retryOptions: { maxRetries: 2 },
    });

    if (!data || !data.list || !Array.isArray(data.list)) {
      logger.warn('æºè§£æ', `${apiSite.name} è¿”å›æ•°æ®æ ¼å¼é”™è¯¯`, { data });
      return [];
    }

    logger.debug('æºè§£æ', `${apiSite.name} è¿”å› ${data.list.length} æ¡ç»“æœ`);

    const results = data.list.map((item: ApiSearchItem) => {
      const episodes = extractM3u8Links(item.vod_play_url || '');

      if (episodes.length === 0) {
        logger.warn(
          'æºè§£æ',
          `${apiSite.name} - ${item.vod_name} æ²¡æœ‰æå–åˆ°M3U8é“¾æ¥`,
          {
            vod_play_url: item.vod_play_url,
          }
        );
      }

      return {
        // ...
      };
    });

    const duration = Date.now() - startTime;
    logger.info('æºè§£æ', `æœç´¢å®Œæˆ: ${apiSite.name}`, {
      resultCount: results.length,
      duration: `${duration}ms`,
    });

    return results;
  } catch (error) {
    const duration = Date.now() - startTime;
    logger.error('æºè§£æ', `æœç´¢å¤±è´¥: ${apiSite.name}`, {
      query,
      duration: `${duration}ms`,
      error,
    });
    return [];
  }
}
```

**é¢„æœŸæ•ˆæœ**:

- âœ… è¯¦ç»†çš„è§£ææ—¥å¿—
- âœ… ä¾¿äºè°ƒè¯•é—®é¢˜
- âœ… å¯ä»¥ç»Ÿè®¡æ¯ä¸ªæºçš„æ€§èƒ½
- âœ… ç”Ÿäº§ç¯å¢ƒå¯ä»¥å…³é—­ DEBUG æ—¥å¿—

---

### ğŸ’¡ ä½ä¼˜å…ˆçº§ä¼˜åŒ–

#### ä¼˜åŒ– 6ï¼šç¼“å­˜ä¼˜åŒ–

**ç›®æ ‡**: æé«˜é‡å¤è¯·æ±‚çš„å“åº”é€Ÿåº¦

**å®æ–½æ­¥éª¤**:

1. åˆ†å±‚ç¼“å­˜ç­–ç•¥

```typescript
// 1. æœç´¢ç»“æœç¼“å­˜ï¼ˆçŸ­æ—¶é—´ï¼‰
const searchCache = new LRUCache<string, SearchResult[]>(500);
const SEARCH_CACHE_TTL = 2 * 60 * 1000; // 2åˆ†é’Ÿ

// 2. è¯¦æƒ…ç¼“å­˜ï¼ˆä¸­ç­‰æ—¶é—´ï¼‰
const detailCache = new LRUCache<string, SearchResult>(1000);
const DETAIL_CACHE_TTL = 10 * 60 * 1000; // 10åˆ†é’Ÿ

// 3. M3U8é“¾æ¥ç¼“å­˜ï¼ˆé•¿æ—¶é—´ï¼‰
const m3u8Cache = new LRUCache<string, string[]>(2000);
const M3U8_CACHE_TTL = 60 * 60 * 1000; // 1å°æ—¶
```

2. åœ¨è§£æä¸­ä½¿ç”¨ç¼“å­˜

```typescript
export async function searchFromApi(
  apiSite: ApiSite,
  query: string
): Promise<SearchResult[]> {
  // æ£€æŸ¥ç¼“å­˜
  const cacheKey = `search:${apiSite.key}:${query}`;
  const cached = searchCache.get(cacheKey);

  if (cached) {
    logger.debug('æºè§£æ', `å‘½ä¸­æœç´¢ç¼“å­˜: ${apiSite.name}`, { query });
    return cached;
  }

  // æ‰§è¡Œæœç´¢
  const results = await doSearch(apiSite, query);

  // å†™å…¥ç¼“å­˜
  searchCache.set(cacheKey, results, SEARCH_CACHE_TTL);

  return results;
}
```

**é¢„æœŸæ•ˆæœ**:

- âœ… å‡å°‘é‡å¤è¯·æ±‚
- âœ… æé«˜å“åº”é€Ÿåº¦
- âœ… é™ä½æºç«™å‹åŠ›

---

#### ä¼˜åŒ– 7ï¼šæ€§èƒ½ç›‘æ§

**ç›®æ ‡**: äº†è§£æ¯ä¸ªæºçš„è¡¨ç°ï¼Œè‡ªåŠ¨è¯†åˆ«é—®é¢˜æº

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºç›‘æ§ç³»ç»Ÿ

```typescript
// src/lib/source-monitor.ts

interface SourceMetrics {
  sourceName: string;
  sourceKey: string;

  // è¯·æ±‚ç»Ÿè®¡
  totalRequests: number;
  successCount: number;
  failureCount: number;

  // æ€§èƒ½ç»Ÿè®¡
  avgResponseTime: number;
  minResponseTime: number;
  maxResponseTime: number;

  // è§£æç»Ÿè®¡
  totalResults: number;
  avgResultsPerSearch: number;
  validM3u8Count: number;
  invalidM3u8Count: number;

  // é”™è¯¯ç»Ÿè®¡
  lastError?: string;
  lastErrorTime?: number;
  errorRate: number;

  // å¥åº·çŠ¶æ€
  healthScore: number; // 0-100
  isHealthy: boolean;
}

class SourceMonitor {
  private metrics = new Map<string, SourceMetrics>();

  recordRequest(
    sourceName: string,
    success: boolean,
    duration: number,
    results?: SearchResult[]
  ) {
    let metric = this.metrics.get(sourceName);

    if (!metric) {
      metric = {
        sourceName,
        sourceKey: sourceName,
        totalRequests: 0,
        successCount: 0,
        failureCount: 0,
        avgResponseTime: 0,
        minResponseTime: Infinity,
        maxResponseTime: 0,
        totalResults: 0,
        avgResultsPerSearch: 0,
        validM3u8Count: 0,
        invalidM3u8Count: 0,
        errorRate: 0,
        healthScore: 100,
        isHealthy: true,
      };
    }

    metric.totalRequests++;

    if (success) {
      metric.successCount++;

      // æ›´æ–°å“åº”æ—¶é—´
      metric.minResponseTime = Math.min(metric.minResponseTime, duration);
      metric.maxResponseTime = Math.max(metric.maxResponseTime, duration);
      metric.avgResponseTime =
        (metric.avgResponseTime * (metric.successCount - 1) + duration) /
        metric.successCount;

      // æ›´æ–°ç»“æœç»Ÿè®¡
      if (results) {
        metric.totalResults += results.length;
        metric.avgResultsPerSearch = metric.totalResults / metric.successCount;

        results.forEach((r) => {
          metric!.validM3u8Count += r.episodes.length;
        });
      }
    } else {
      metric.failureCount++;
    }

    // æ›´æ–°é”™è¯¯ç‡
    metric.errorRate = metric.failureCount / metric.totalRequests;

    // è®¡ç®—å¥åº·åˆ†æ•°
    metric.healthScore = this.calculateHealthScore(metric);
    metric.isHealthy = metric.healthScore >= 60;

    this.metrics.set(sourceName, metric);
  }

  private calculateHealthScore(metric: SourceMetrics): number {
    let score = 100;

    // é”™è¯¯ç‡å½±å“ï¼ˆæœ€å¤šæ‰£50åˆ†ï¼‰
    score -= metric.errorRate * 50;

    // å“åº”æ—¶é—´å½±å“ï¼ˆæœ€å¤šæ‰£20åˆ†ï¼‰
    if (metric.avgResponseTime > 5000) {
      score -= 20;
    } else if (metric.avgResponseTime > 3000) {
      score -= 10;
    }

    // ç»“æœæ•°é‡å½±å“ï¼ˆæœ€å¤šæ‰£30åˆ†ï¼‰
    if (metric.avgResultsPerSearch === 0) {
      score -= 30;
    } else if (metric.avgResultsPerSearch < 5) {
      score -= 15;
    }

    return Math.max(0, score);
  }

  getMetrics(sourceName?: string): SourceMetrics | SourceMetrics[] {
    if (sourceName) {
      return this.metrics.get(sourceName) || null;
    }
    return Array.from(this.metrics.values());
  }

  getHealthySources(): SourceMetrics[] {
    return Array.from(this.metrics.values())
      .filter((m) => m.isHealthy)
      .sort((a, b) => b.healthScore - a.healthScore);
  }

  getUnhealthySources(): SourceMetrics[] {
    return Array.from(this.metrics.values())
      .filter((m) => !m.isHealthy)
      .sort((a, b) => a.healthScore - b.healthScore);
  }
}

export const sourceMonitor = new SourceMonitor();
```

2. åœ¨è§£æä¸­ä½¿ç”¨ç›‘æ§

```typescript
export async function searchFromApi(
  apiSite: ApiSite,
  query: string
): Promise<SearchResult[]> {
  const startTime = Date.now();

  try {
    const results = await doSearch(apiSite, query);

    const duration = Date.now() - startTime;
    sourceMonitor.recordRequest(apiSite.name, true, duration, results);

    return results;
  } catch (error) {
    const duration = Date.now() - startTime;
    sourceMonitor.recordRequest(apiSite.name, false, duration);

    throw error;
  }
}
```

3. æä¾›ç›‘æ§ API

```typescript
// src/app/api/admin/source-metrics/route.ts

export async function GET() {
  const allMetrics = sourceMonitor.getMetrics();
  const healthySources = sourceMonitor.getHealthySources();
  const unhealthySources = sourceMonitor.getUnhealthySources();

  return NextResponse.json({
    allMetrics,
    healthySources,
    unhealthySources,
    summary: {
      totalSources: allMetrics.length,
      healthyCount: healthySources.length,
      unhealthyCount: unhealthySources.length,
    },
  });
}
```

**é¢„æœŸæ•ˆæœ**:

- âœ… å®æ—¶äº†è§£æ¯ä¸ªæºçš„å¥åº·çŠ¶å†µ
- âœ… è‡ªåŠ¨è¯†åˆ«æ…¢æºå’Œé—®é¢˜æº
- âœ… æ•°æ®é©±åŠ¨ä¼˜åŒ–
- âœ… ç®¡ç†å‘˜å¯æŸ¥çœ‹ç›‘æ§é¢æ¿

---

#### ä¼˜åŒ– 8ï¼šæ™ºèƒ½æºé€‰æ‹©

**ç›®æ ‡**: æ ¹æ®å†å²è¡¨ç°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æº

**å®æ–½æ­¥éª¤**:

1. å®ç°æºæ’åºç®—æ³•

```typescript
/**
 * æ ¹æ®å¥åº·åˆ†æ•°å’Œæ€§èƒ½å¯¹æºè¿›è¡Œæ’åº
 */
function sortSourcesByPerformance(sources: ApiSite[]): ApiSite[] {
  return sources
    .map((source) => {
      const metrics = sourceMonitor.getMetrics(source.name) as SourceMetrics;
      return {
        source,
        healthScore: metrics?.healthScore || 50,
        avgResponseTime: metrics?.avgResponseTime || Infinity,
      };
    })
    .sort((a, b) => {
      // 1. é¦–å…ˆæŒ‰å¥åº·åˆ†æ•°æ’åº
      if (Math.abs(a.healthScore - b.healthScore) > 10) {
        return b.healthScore - a.healthScore;
      }

      // 2. å¥åº·åˆ†æ•°ç›¸è¿‘æ—¶ï¼ŒæŒ‰å“åº”æ—¶é—´æ’åº
      return a.avgResponseTime - b.avgResponseTime;
    })
    .map((item) => item.source);
}
```

2. åœ¨æœç´¢ API ä¸­ä½¿ç”¨

```typescript
// src/app/api/search/route.ts

export async function GET(request: Request) {
  // ...è·å–å¯ç”¨æº
  let availableSites = await getAvailableApiSites(shouldFilterAdult);

  // æ ¹æ®æ€§èƒ½æ’åº
  availableSites = sortSourcesByPerformance(availableSites);

  // ä¼˜å…ˆä½¿ç”¨å¥åº·çš„æº
  const healthySources = sourceMonitor.getHealthySources();
  availableSites = availableSites.filter((s) =>
    healthySources.some((h) => h.sourceName === s.name)
  );

  // å¹¶å‘æœç´¢
  const searchPromises = availableSites.map((site) =>
    searchFromApi(site, query)
  );
  const searchResults = (await Promise.all(searchPromises)).flat();

  // ...
}
```

**é¢„æœŸæ•ˆæœ**:

- âœ… ä¼˜å…ˆä½¿ç”¨è¡¨ç°å¥½çš„æº
- âœ… é¿å…ä½¿ç”¨æ…¢æºå’Œé—®é¢˜æº
- âœ… æé«˜æ•´ä½“æœç´¢é€Ÿåº¦
- âœ… è‡ªé€‚åº”è°ƒæ•´

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æµ‹

### é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

| ä¼˜åŒ–é¡¹             | å½“å‰é—®é¢˜       | ä¼˜åŒ–åæ•ˆæœ        | ä¼˜å…ˆçº§ |
| ------------------ | -------------- | ----------------- | ------ |
| **ç»Ÿä¸€ M3U8 æå–** | åˆ†é¡µè§£æä¸ä¸€è‡´ | âœ… 100%ä¸€è‡´       | ğŸ”´ é«˜  |
| **æ”¯æŒå¤šæ’­æ”¾æº**   | åªå–ç¬¬ä¸€ä¸ªæº   | âœ… æ’­æ”¾æˆåŠŸç‡+30% | ğŸ”´ é«˜  |
| **å¢å¼º URL éªŒè¯**  | æå–åˆ°ä¸­è½¬é¡µé¢ | âœ… è¿‡æ»¤æ— æ•ˆé“¾æ¥   | ğŸ”´ é«˜  |

### ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

| ä¼˜åŒ–é¡¹           | å½“å‰é—®é¢˜          | ä¼˜åŒ–åæ•ˆæœ        | ä¼˜å…ˆçº§ |
| ---------------- | ----------------- | ----------------- | ------ |
| **æ‰©å±•ç‰¹æ®Šæº**   | åªæ”¯æŒ 1 ä¸ªç‰¹æ®Šæº | âœ… æ”¯æŒ 10+ç‰¹æ®Šæº | ğŸŸ¡ ä¸­  |
| **è§£æé”™è¯¯æ—¥å¿—** | æ— æ³•è°ƒè¯•          | âœ… è¯¦ç»†æ—¥å¿—       | ğŸŸ¡ ä¸­  |

### ä½ä¼˜å…ˆçº§ä¼˜åŒ–

| ä¼˜åŒ–é¡¹         | å½“å‰é—®é¢˜       | ä¼˜åŒ–åæ•ˆæœ      | ä¼˜å…ˆçº§ |
| -------------- | -------------- | --------------- | ------ |
| **ç¼“å­˜ä¼˜åŒ–**   | é‡å¤è¯·æ±‚       | âœ… å“åº”é€Ÿåº¦+50% | ğŸŸ¢ ä½  |
| **æ€§èƒ½ç›‘æ§**   | æ— æ³•è¯†åˆ«é—®é¢˜æº | âœ… å®æ—¶ç›‘æ§     | ğŸŸ¢ ä½  |
| **æ™ºèƒ½æºé€‰æ‹©** | å¹³ç­‰å¯¹å¾…æ‰€æœ‰æº | âœ… è‡ªåŠ¨ä¼˜åŒ–     | ğŸŸ¢ ä½  |

---

## ğŸ¯ å®æ–½å»ºè®®

### Phase 1: æ ¸å¿ƒä¿®å¤ï¼ˆ1-2 å¤©ï¼‰

**å¿…é¡»å®æ–½**:

- âœ… ç»Ÿä¸€ M3U8 æå–é€»è¾‘
- âœ… å¢å¼º URL éªŒè¯
- âœ… æ”¯æŒå¤šæ’­æ”¾æº

**é¢„æœŸæ”¶ç›Š**:

- è§£æå‡†ç¡®ç‡ï¼š70% â†’ 95%
- æ’­æ”¾æˆåŠŸç‡ï¼š60% â†’ 85%

---

### Phase 2: åŠŸèƒ½å¢å¼ºï¼ˆ3-5 å¤©ï¼‰

**æ¨èå®æ–½**:

- âœ… æ‰©å±•ç‰¹æ®Šæºæ”¯æŒ
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—
- âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†

**é¢„æœŸæ”¶ç›Š**:

- æ”¯æŒçš„æºæ•°é‡ï¼š+50%
- è°ƒè¯•æ•ˆç‡ï¼š+80%

---

### Phase 3: æ€§èƒ½ä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

**å¯é€‰å®æ–½**:

- âœ… ç¼“å­˜ä¼˜åŒ–
- âœ… æ€§èƒ½ç›‘æ§
- âœ… æ™ºèƒ½æºé€‰æ‹©

**é¢„æœŸæ”¶ç›Š**:

- å“åº”é€Ÿåº¦ï¼š+50%
- ç³»ç»Ÿç¨³å®šæ€§ï¼š+30%

---

## ğŸ“ æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```typescript
// tests/downstream.test.ts

describe('extractM3u8Links', () => {
  it('åº”è¯¥æ­£ç¡®æå–å¤šä¸ªæ’­æ”¾æº', () => {
    const vodPlayUrl =
      'ç¬¬01é›†$https://vip.dytt-cinema.com/share/xxx#' +
      'ç¬¬02é›†$https://vip.dytt-cinema.com/share/yyy$$$' +
      'ç¬¬01é›†$https://vip.dytt-cinema.com/20250215/2419_xxx/index.m3u8#' +
      'ç¬¬02é›†$https://vip.dytt-cinema.com/20250215/2420_yyy/index.m3u8';

    const result = extractM3u8Links(vodPlayUrl);

    expect(result).toHaveLength(2);
    expect(result[0]).toContain('index.m3u8');
    expect(result[0]).not.toContain('/share/');
  });

  it('åº”è¯¥è¿‡æ»¤æ— æ•ˆé“¾æ¥', () => {
    const vodPlayUrl =
      'ç¬¬01é›†$https://example.com/share/xxx#' + // ä¸­è½¬é¡µé¢ï¼Œåº”è¯¥è¢«è¿‡æ»¤
      'ç¬¬02é›†$https://example.com/video.m3u8'; // æœ‰æ•ˆé“¾æ¥

    const result = extractM3u8Links(vodPlayUrl);

    expect(result).toHaveLength(1);
    expect(result[0]).toBe('https://example.com/video.m3u8');
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
// tests/integration/source-parsing.test.ts

describe('æºè§£æé›†æˆæµ‹è¯•', () => {
  it('åº”è¯¥æ­£ç¡®è§£ædyttæº', async () => {
    const apiSite: ApiSite = {
      key: 'dytt',
      api: 'http://caiji.dyttzyapi.com/api.php/provide/vod',
      name: 'ç”µå½±å¤©å ‚',
    };

    const results = await searchFromApi(apiSite, 'æ–—ç ´è‹ç©¹');

    expect(results).toBeInstanceOf(Array);
    expect(results.length).toBeGreaterThan(0);

    const firstResult = results[0];
    expect(firstResult.episodes).toBeInstanceOf(Array);
    expect(firstResult.episodes.length).toBeGreaterThan(0);

    // éªŒè¯æå–çš„é“¾æ¥æ ¼å¼
    firstResult.episodes.forEach((url) => {
      expect(url).toMatch(/^https?:\/\//);
      expect(url).toMatch(/\.m3u8$/);
      expect(url).not.toContain('/share/');
    });
  });
});
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **åˆ†ææŠ¥å‘Š**: `è¿‡æ»¤ç­–ç•¥åˆ†ææŠ¥å‘Š.md` - è¿‡æ»¤ç­–ç•¥åˆ†æ
- **ä¼˜åŒ–æŠ¥å‘Š**: `è¿‡æ»¤ç­–ç•¥ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` - è¿‡æ»¤ç­–ç•¥ä¼˜åŒ–
- **æºè§£æ**: `æºè§£æåˆ†ææŠ¥å‘Š.md` - æœ¬æ–‡ä»¶

---

<div align="center">
  <strong>âœ… æºè§£æåˆ†æå®Œæˆï¼ğŸŠ</strong>
</div>

---

**æœ€åæ›´æ–°**: 2025-11-12
