# ğŸ›¡ï¸ V0TV è¿‡æ»¤ç­–ç•¥å®Œæ•´åˆ†ææŠ¥å‘Š

> æ·±åº¦åˆ†æé¡¹ç›®ä¸­çš„å¹¿å‘Šè¿‡æ»¤å’Œå†…å®¹è¿‡æ»¤æœºåˆ¶

---

## ğŸ“‹ ç›®å½•

1. [å¹¿å‘Šè¿‡æ»¤ç­–ç•¥](#1-å¹¿å‘Šè¿‡æ»¤ç­–ç•¥)
2. [æˆäººå†…å®¹è¿‡æ»¤ç­–ç•¥](#2-æˆäººå†…å®¹è¿‡æ»¤ç­–ç•¥)
3. [å…¶ä»–è¿‡æ»¤æœºåˆ¶](#3-å…¶ä»–è¿‡æ»¤æœºåˆ¶)
4. [ä¼˜åŒ–å»ºè®®](#4-ä¼˜åŒ–å»ºè®®)

---

## 1. å¹¿å‘Šè¿‡æ»¤ç­–ç•¥

### ğŸ“ ä½ç½®
**æ–‡ä»¶**: `src/app/play/page.tsx` (è¡Œ 399-447)

### ğŸ¯ æ ¸å¿ƒæœºåˆ¶

#### 1.1 M3U8å¹¿å‘Šè¿‡æ»¤å‡½æ•°

```typescript
function filterAdsFromM3U8(m3u8Content: string): string {
  if (!m3u8Content) return '';

  // æŒ‰è¡Œåˆ†å‰²M3U8å†…å®¹
  const lines = m3u8Content.split('\n');
  const filteredLines = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // åªè¿‡æ»¤#EXT-X-DISCONTINUITYæ ‡è¯†
    if (!line.includes('#EXT-X-DISCONTINUITY')) {
      filteredLines.push(line);
    }
  }

  return filteredLines.join('\n');
}
```

**å·¥ä½œåŸç†**:
- `#EXT-X-DISCONTINUITY` æ˜¯HLSæµä¸­çš„ä¸è¿ç»­æ ‡è®°
- å¹¿å‘Šç‰‡æ®µé€šå¸¸ä½¿ç”¨æ­¤æ ‡è®°ä¸æ­£ç‰‡åˆ†éš”
- ç§»é™¤æ­¤æ ‡è®°å¯ä»¥è·³è¿‡å¹¿å‘Šç‰‡æ®µ

**ä¼˜ç‚¹**:
- âœ… ç®€å•æœ‰æ•ˆ
- âœ… å¯¹æ­£å¸¸æ’­æ”¾æ— å½±å“
- âœ… ä¸ä¼šè¯¯åˆ æ­£ç‰‡å†…å®¹

**å±€é™æ€§**:
- âš ï¸ åªèƒ½è¿‡æ»¤ä½¿ç”¨ `DISCONTINUITY` æ ‡è®°çš„å¹¿å‘Š
- âš ï¸ æ— æ³•è¿‡æ»¤åµŒå…¥å¼å¹¿å‘Šï¼ˆæ— æ ‡è®°çš„å¹¿å‘Šï¼‰

---

#### 1.2 è‡ªå®šä¹‰HLSåŠ è½½å™¨

```typescript
class CustomHlsJsLoader extends Hls.DefaultConfig.loader {
  constructor(config: any) {
    super(config);
    const load = this.load.bind(this);
    this.load = function (context: any, config: any, callbacks: any) {
      // æ‹¦æˆªmanifestå’Œlevelè¯·æ±‚
      if (
        (context as any).type === 'manifest' ||
        (context as any).type === 'level'
      ) {
        const onSuccess = callbacks.onSuccess;
        callbacks.onSuccess = function (
          response: any,
          stats: any,
          context: any
        ) {
          // å¦‚æœæ˜¯m3u8æ–‡ä»¶ï¼Œå¤„ç†å†…å®¹ä»¥ç§»é™¤å¹¿å‘Šåˆ†æ®µ
          if (response.data && typeof response.data === 'string') {
            // è¿‡æ»¤æ‰å¹¿å‘Šæ®µ
            response.data = filterAdsFromM3U8(response.data);
          }
          return onSuccess(response, stats, context, null);
        };
      }
      // æ‰§è¡ŒåŸå§‹loadæ–¹æ³•
      load(context, config, callbacks);
    };
  }
}
```

**å·¥ä½œåŸç†**:
1. ç»§æ‰¿ `Hls.DefaultConfig.loader`
2. æ‹¦æˆª `manifest` å’Œ `level` ç±»å‹çš„è¯·æ±‚
3. åœ¨ `onSuccess` å›è°ƒä¸­è¿‡æ»¤M3U8å†…å®¹
4. åªå¤„ç†æ–‡æœ¬ç±»å‹çš„å“åº”æ•°æ®

**ä½¿ç”¨åœºæ™¯**:
- Master playliståŠ è½½ï¼ˆä¸»æ’­æ”¾åˆ—è¡¨ï¼‰
- Level playliståŠ è½½ï¼ˆåˆ†è¾¨ç‡çº§åˆ«æ’­æ”¾åˆ—è¡¨ï¼‰

---

#### 1.3 å»å¹¿å‘Šå¼€å…³

**çŠ¶æ€ç®¡ç†**:
```typescript
// ä» localStorage ç»§æ‰¿ï¼Œé»˜è®¤ true
const [blockAdEnabled, setBlockAdEnabled] = useState<boolean>(() => {
  if (typeof window !== 'undefined') {
    const v = localStorage.getItem('enable_blockad');
    if (v !== null) return v === 'true';
  }
  return true; // é»˜è®¤å¼€å¯å»å¹¿å‘Š
});
```

**æ’­æ”¾å™¨é…ç½®**:
```typescript
const hls = new Hls({
  // ... å…¶ä»–é…ç½®

  /* è‡ªå®šä¹‰loader */
  loader: blockAdEnabledRef.current
    ? CustomHlsJsLoader           // âœ… å¼€å¯å»å¹¿å‘Š
    : Hls.DefaultConfig.loader,   // âŒ ä½¿ç”¨é»˜è®¤loader
});
```

**ç”¨æˆ·æ§åˆ¶**:
```typescript
settings: [
  {
    html: 'å»å¹¿å‘Š',
    icon: '<text>AD</text>',
    tooltip: blockAdEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­',
    onClick() {
      const newVal = !blockAdEnabled;
      try {
        localStorage.setItem('enable_blockad', String(newVal));

        // é‡æ–°åŠ è½½æ’­æ”¾å™¨ä»¥åº”ç”¨æ–°è®¾ç½®
        if (artPlayerRef.current) {
          resumeTimeRef.current = artPlayerRef.current.currentTime;
          if (artPlayerRef.current.video?.hls) {
            artPlayerRef.current.video.hls.destroy();
          }
          artPlayerRef.current.destroy();
          artPlayerRef.current = null;
        }
        setBlockAdEnabled(newVal);
      } catch (_) {
        // ignore
      }
      return newVal ? 'å½“å‰å¼€å¯' : 'å½“å‰å…³é—­';
    },
  },
]
```

**äº¤äº’æµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»"å»å¹¿å‘Š"æŒ‰é’®
  â†“
åˆ‡æ¢çŠ¶æ€
  â†“
ä¿å­˜åˆ° localStorage
  â†“
é”€æ¯å½“å‰æ’­æ”¾å™¨
  â†“
é‡æ–°åˆ›å»ºæ’­æ”¾å™¨ï¼ˆåº”ç”¨æ–°è®¾ç½®ï¼‰
  â†“
æ¢å¤æ’­æ”¾è¿›åº¦
```

---

### ğŸ“Š å¹¿å‘Šè¿‡æ»¤æ•ˆæœ

| å¹¿å‘Šç±»å‹ | æ˜¯å¦èƒ½è¿‡æ»¤ | è¯´æ˜ |
|---------|-----------|------|
| **DISCONTINUITYæ ‡è®°å¹¿å‘Š** | âœ… èƒ½è¿‡æ»¤ | ä¸»è¦è¿‡æ»¤å¯¹è±¡ |
| **ç‹¬ç«‹å¹¿å‘Šç‰‡æ®µ** | âœ… èƒ½è¿‡æ»¤ | é€šè¿‡ç§»é™¤ä¸è¿ç»­æ ‡è®°å®ç° |
| **åµŒå…¥å¼å¹¿å‘Š** | âŒ æ— æ³•è¿‡æ»¤ | æ— ç‰¹æ®Šæ ‡è®°ï¼Œä¸æ­£ç‰‡æ··åˆ |
| **å‰ç½®å¹¿å‘Š** | âš ï¸ éƒ¨åˆ†è¿‡æ»¤ | å–å†³äºæ˜¯å¦ä½¿ç”¨ DISCONTINUITY |
| **ç‰‡ä¸­å¹¿å‘Š** | âœ… èƒ½è¿‡æ»¤ | é€šå¸¸æœ‰ä¸è¿ç»­æ ‡è®° |

---

### ğŸ’¡ å¹¿å‘Šè¿‡æ»¤ä¼˜åŒ–å»ºè®®

#### å»ºè®®1ï¼šå¢å¼ºå¹¿å‘Šè¯†åˆ«

```typescript
function filterAdsFromM3U8Advanced(m3u8Content: string): string {
  if (!m3u8Content) return '';

  const lines = m3u8Content.split('\n');
  const filteredLines = [];
  let skipNext = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // 1. ç§»é™¤ DISCONTINUITY æ ‡è®°
    if (line.includes('#EXT-X-DISCONTINUITY')) {
      skipNext = true; // æ ‡è®°ä¸‹ä¸€ä¸ªç‰‡æ®µå¯èƒ½æ˜¯å¹¿å‘Š
      continue;
    }

    // 2. æ£€æµ‹å¸¸è§å¹¿å‘Šç‰‡æ®µç‰¹å¾
    const isAdSegment =
      line.includes('ad.') ||
      line.includes('adv.') ||
      line.includes('commercial') ||
      line.includes('preroll') ||
      /ad[_-]?\d+/.test(line);

    if (isAdSegment) {
      console.log(`[å¹¿å‘Šè¿‡æ»¤] æ£€æµ‹åˆ°å¹¿å‘Šç‰‡æ®µ: ${line}`);
      continue; // è·³è¿‡å¹¿å‘Šç‰‡æ®µ
    }

    // 3. å¦‚æœä¸Šä¸€è¡Œæ˜¯ DISCONTINUITYï¼Œä¸”å½“å‰æ˜¯ .ts/.m3u8ï¼Œå¯èƒ½æ˜¯å¹¿å‘Š
    if (skipNext && (line.endsWith('.ts') || line.endsWith('.m3u8'))) {
      console.log(`[å¹¿å‘Šè¿‡æ»¤] è·³è¿‡ä¸è¿ç»­ç‰‡æ®µ: ${line}`);
      skipNext = false;
      continue;
    }

    skipNext = false;
    filteredLines.push(line);
  }

  return filteredLines.join('\n');
}
```

**æ–°å¢è¯†åˆ«è§„åˆ™**:
- æ–‡ä»¶ååŒ…å« `ad.`, `adv.`, `commercial`, `preroll` ç­‰å…³é”®è¯
- DISCONTINUITY åçš„ç¬¬ä¸€ä¸ªç‰‡æ®µï¼ˆå¯èƒ½æ˜¯å¹¿å‘Šï¼‰
- ä½¿ç”¨æ­£åˆ™åŒ¹é… `ad_1`, `ad-2` ç­‰æ¨¡å¼

---

#### å»ºè®®2ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—

```typescript
function filterAdsFromM3U8WithLogging(m3u8Content: string): string {
  if (!m3u8Content) return '';

  const lines = m3u8Content.split('\n');
  const filteredLines = [];
  let removedCount = 0;
  let removedLines: string[] = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (line.includes('#EXT-X-DISCONTINUITY')) {
      removedCount++;
      removedLines.push(line);
      continue;
    }

    filteredLines.push(line);
  }

  if (removedCount > 0) {
    console.log(`[å¹¿å‘Šè¿‡æ»¤] ç§»é™¤äº† ${removedCount} ä¸ªä¸è¿ç»­æ ‡è®°`);
    console.log(`[å¹¿å‘Šè¿‡æ»¤] ç§»é™¤çš„è¡Œ:`, removedLines);
  }

  return filteredLines.join('\n');
}
```

---

#### å»ºè®®3ï¼šç”¨æˆ·åé¦ˆæœºåˆ¶

```typescript
// åœ¨æ’­æ”¾å™¨è®¾ç½®ä¸­æ·»åŠ å¹¿å‘Šåé¦ˆæŒ‰é’®
settings: [
  {
    html: 'å»å¹¿å‘Š',
    // ... ç°æœ‰é…ç½®
  },
  {
    html: 'æŠ¥å‘Šå¹¿å‘Š',
    icon: '<text>âš ï¸</text>',
    tooltip: 'å¦‚æœå¹¿å‘Šæœªè¢«è¿‡æ»¤ï¼Œç‚¹å‡»æŠ¥å‘Š',
    onClick() {
      const currentUrl = artPlayerRef.current?.url;
      console.log('ç”¨æˆ·æŠ¥å‘Šå¹¿å‘Šæœªè¿‡æ»¤:', currentUrl);

      // å¯é€‰ï¼šå‘é€åˆ°æœåŠ¡å™¨æ”¶é›†å¹¿å‘Šç‰¹å¾
      fetch('/api/report-ad', {
        method: 'POST',
        body: JSON.stringify({
          videoUrl: currentUrl,
          timestamp: Date.now(),
        }),
      });

      return 'å·²æäº¤åé¦ˆ';
    },
  },
]
```

---

## 2. æˆäººå†…å®¹è¿‡æ»¤ç­–ç•¥

### ğŸ“ ä½ç½®
- **ç»„ä»¶**: `src/components/AdultContentFilter.tsx`
- **API**: `src/app/api/search/route.ts`
- **é…ç½®**: `src/lib/config.ts`

### ğŸ¯ æ ¸å¿ƒæœºåˆ¶

#### 2.1 è¿‡æ»¤æµç¨‹

```
ç”¨æˆ·æœç´¢
  â†“
[è·å–ç”¨æˆ·è®¾ç½®]
  â†“
filter_adult_content = ?
  â†“
true (é»˜è®¤)              false
  â†“                      â†“
[åªè·å–éæˆäººæº]      [è·å–æ‰€æœ‰æº]
  â†“                      â†“
è¿”å›å¸¸è§„ç»“æœ          è¿”å›æ‰€æœ‰ç»“æœ
```

---

#### 2.2 ç”¨æˆ·è®¾ç½®ç®¡ç†

**é»˜è®¤å€¼**: `filter_adult_content = true` ï¼ˆé»˜è®¤å¼€å¯è¿‡æ»¤ï¼‰

**å­˜å‚¨ä½ç½®**:
- æ•°æ®åº“ä¸­çš„ `user_settings` è¡¨
- å­—æ®µï¼š`filter_adult_content: boolean`

**è·å–è®¾ç½®** (`src/app/api/search/route.ts:52-62`):
```typescript
let shouldFilterAdult = true; // é»˜è®¤è¿‡æ»¤
if (userName) {
  try {
    const storage = getStorage();
    const userSettings = await storage.getUserSettings(userName);
    // å¦‚æœç”¨æˆ·è®¾ç½®å­˜åœ¨ä¸”æ˜ç¡®è®¾ä¸ºfalseï¼Œåˆ™ä¸è¿‡æ»¤ï¼›å¦åˆ™é»˜è®¤è¿‡æ»¤
    shouldFilterAdult = userSettings?.filter_adult_content !== false;
  } catch (error) {
    // å‡ºé”™æ—¶é»˜è®¤è¿‡æ»¤æˆäººå†…å®¹
    shouldFilterAdult = true;
  }
}
```

---

#### 2.3 èµ„æºæºæ ‡è®°

**é…ç½®æ–‡ä»¶** (`public/config.json`):
```json
{
  "apiSites": {
    "heimuer": {
      "api": "https://heimuer.tv/api",
      "name": "é»‘æœ¨è€³èµ„æº",
      "is_adult": false    // âœ… éæˆäººå†…å®¹
    },
    "caiji08": {
      "api": "https://caiji08.com/api",
      "name": "é‡‡é›†08",
      "is_adult": true     // âš ï¸ æˆäººå†…å®¹
    }
  }
}
```

**è¿‡æ»¤é€»è¾‘** (`src/lib/config.ts:395-423`):
```typescript
export async function getAvailableApiSites(filterAdult = false): Promise<ApiSite[]> {
  const config = await getConfig();

  // é˜²å¾¡æ€§æ£€æŸ¥
  if (!config.SourceConfig || !Array.isArray(config.SourceConfig)) {
    return [];
  }

  // ä¸ºæ¯ä¸ªæºç¡®ä¿ is_adult å­—æ®µå­˜åœ¨
  let sites = config.SourceConfig
    .filter((s) => !s.disabled)
    .map((s) => ({
      ...s,
      is_adult: s.is_adult === true // ä¸¥æ ¼æ£€æŸ¥
    }));

  // å¦‚æœéœ€è¦è¿‡æ»¤æˆäººå†…å®¹ï¼Œåˆ™æ’é™¤æ ‡è®°ä¸ºæˆäººå†…å®¹çš„èµ„æºç«™
  if (filterAdult) {
    sites = sites.filter((s) => !s.is_adult);
  }

  return sites.map((s) => ({
    key: s.key,
    name: s.name,
    api: s.api,
    detail: s.detail,
  }));
}
```

---

#### 2.4 ç”¨æˆ·ç•Œé¢ç»„ä»¶

**ç»„ä»¶** (`src/components/AdultContentFilter.tsx`):

**åŠŸèƒ½**:
- âœ… æ˜¾ç¤ºå½“å‰è¿‡æ»¤çŠ¶æ€
- âœ… åˆ‡æ¢å¼€å…³
- âœ… è‡ªåŠ¨åˆ·æ–°ç¼“å­˜
- âœ… é”™è¯¯æç¤º

**æ ¸å¿ƒä»£ç **:
```typescript
// æ›´æ–°ç”¨æˆ·è®¾ç½®
const handleToggle = async () => {
  if (!userName || isLoading) return;

  setIsLoading(true);
  setError(null);

  try {
    const response = await fetch('/api/user/settings', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${userName}`,
      },
      body: JSON.stringify({
        settings: {
          filter_adult_content: !isEnabled,
        },
      }),
    });

    if (response.ok) {
      const newState = !isEnabled;
      setIsEnabled(newState);

      // å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·è®¾ç½®ç¼“å­˜
      try {
        await fetch('/api/search?q=_cache_refresh_', {
          headers: {
            'Authorization': `Bearer ${userName}`,
          },
        });
      } catch {
        // å¿½ç•¥åˆ·æ–°ç¼“å­˜çš„é”™è¯¯
      }

      onUpdate?.(newState);
    }
  } catch (err) {
    setError('ç½‘ç»œè¿æ¥å¤±è´¥');
  } finally {
    setIsLoading(false);
  }
};
```

**UIçŠ¶æ€**:
```typescript
{isEnabled
  ? 'å·²å¼€å¯è¿‡æ»¤ï¼Œå°†è‡ªåŠ¨éšè—æ‰€æœ‰æ ‡è®°ä¸º"æˆäºº"çš„èµ„æºç«™åŠå…¶å†…å®¹'
  : 'å·²å…³é—­è¿‡æ»¤ï¼Œæˆäººå†…å®¹å°†åœ¨æœç´¢ç»“æœä¸­å•ç‹¬åˆ†ç»„æ˜¾ç¤º'
}
```

---

### ğŸ“Š æˆäººå†…å®¹è¿‡æ»¤æ•ˆæœ

| åœºæ™¯ | è¿‡æ»¤å¼€å¯ | è¿‡æ»¤å…³é—­ |
|------|---------|---------|
| **æœç´¢ç»“æœ** | åªæ˜¾ç¤ºéæˆäººæº | æ˜¾ç¤ºæ‰€æœ‰æº |
| **è§†é¢‘è¯¦æƒ…** | æ— æ³•è®¿é—®æˆäººæº | å¯ä»¥è®¿é—®æˆäººæº |
| **æ’­æ”¾æºåˆ—è¡¨** | ä¸æ˜¾ç¤ºæˆäººæº | æ˜¾ç¤ºæ‰€æœ‰æºï¼ˆåˆ†ç»„ï¼‰ |
| **æ¨èå†…å®¹** | åªæ¥è‡ªéæˆäººæº | æ¥è‡ªæ‰€æœ‰æº |

---

### ğŸ”’ å®‰å…¨æ€§åˆ†æ

#### âœ… ä¼˜ç‚¹

1. **æœåŠ¡ç«¯éªŒè¯**
   - è¿‡æ»¤åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œå®¢æˆ·ç«¯æ— æ³•ç»•è¿‡
   - ç”¨æˆ·è®¾ç½®å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œä¸ä¾èµ–å‰ç«¯

2. **é»˜è®¤å®‰å…¨**
   - é»˜è®¤å¼€å¯è¿‡æ»¤ï¼ˆ`filter_adult_content = true`ï¼‰
   - æ–°ç”¨æˆ·è‡ªåŠ¨å¯ç”¨è¿‡æ»¤

3. **ç»†ç²’åº¦æ§åˆ¶**
   - æ¯ä¸ªæºéƒ½æœ‰æ˜ç¡®çš„ `is_adult` æ ‡è®°
   - ä¸¥æ ¼æ£€æŸ¥ `is_adult === true`ï¼Œé¿å…è¯¯åˆ¤

#### âš ï¸ å±€é™æ€§

1. **å®¢æˆ·ç«¯å¯ç»•è¿‡**
   ```typescript
   // ç”¨æˆ·å¯ä»¥ç›´æ¥è°ƒç”¨APIå¹¶ä¼ é€’å‚æ•°
   fetch('/api/search?q=xxx&include_adult=true')
   ```
   - è™½ç„¶APIä¼šæ£€æŸ¥ç”¨æˆ·è®¾ç½®ï¼Œä½†å¦‚æœç”¨æˆ·è®¾ç½®äº† `filter_adult_content = false`ï¼Œå®¢æˆ·ç«¯å°±èƒ½è®¿é—®æˆäººå†…å®¹

2. **ä¾èµ–æºç«™æ ‡è®°**
   - å¦‚æœæŸä¸ªæˆäººæºæ²¡æœ‰æ ‡è®° `is_adult: true`ï¼Œä¼šè¢«å½“ä½œå¸¸è§„æº
   - éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ `config.json`

3. **æ— æ³•è¿‡æ»¤æœç´¢ç»“æœä¸­çš„æˆäººå†…å®¹**
   - åªèƒ½è¿‡æ»¤æºï¼Œä¸èƒ½è¿‡æ»¤å•ä¸ªè§†é¢‘
   - å¦‚æœå¸¸è§„æºè¿”å›æˆäººå†…å®¹ï¼Œæ— æ³•è‡ªåŠ¨è¿‡æ»¤

---

### ğŸ’¡ æˆäººå†…å®¹è¿‡æ»¤ä¼˜åŒ–å»ºè®®

#### å»ºè®®1ï¼šæœåŠ¡ç«¯å¼ºåˆ¶éªŒè¯

**å½“å‰é—®é¢˜**:
```typescript
// src/app/api/search/route.ts:48
const includeAdult = searchParams.get('include_adult') === 'true';
```
- å®¢æˆ·ç«¯å¯ä»¥ä¼ é€’ `include_adult=true` å‚æ•°

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
// ç§»é™¤ include_adult å‚æ•°ï¼Œå®Œå…¨ä¾èµ–ç”¨æˆ·è®¾ç½®
const shouldFilterAdult = await getUserFilterSetting(userName);

// å¿½ç•¥å®¢æˆ·ç«¯ä¼ é€’çš„å‚æ•°
// const includeAdult = searchParams.get('include_adult') === 'true'; // âŒ åˆ é™¤

const availableSites = await getAvailableApiSites(shouldFilterAdult);
```

---

#### å»ºè®®2ï¼šå†…å®¹å…³é”®è¯è¿‡æ»¤

```typescript
// åœ¨æœç´¢ç»“æœä¸­äºŒæ¬¡è¿‡æ»¤
function filterAdultContentByKeywords(results: SearchResult[]): SearchResult[] {
  const adultKeywords = [
    'æˆäºº', '18ç¦', 'adult', 'xxx', 'porn',
    'è‰²æƒ…', 'æƒ…è‰²', 'ä¸‰çº§', 'AV', 'æ— ç '
  ];

  return results.filter(result => {
    const title = result.title.toLowerCase();
    const desc = (result.desc || '').toLowerCase();

    return !adultKeywords.some(keyword =>
      title.includes(keyword) || desc.includes(keyword)
    );
  });
}

// åœ¨æœç´¢APIä¸­ä½¿ç”¨
const searchResults = (await Promise.all(searchPromises)).flat();
const filteredResults = shouldFilterAdult
  ? filterAdultContentByKeywords(searchResults)
  : searchResults;
```

---

#### å»ºè®®3ï¼šå®¶é•¿æ§åˆ¶PINç 

```typescript
// ç”¨æˆ·è®¾ç½®ä¸­æ·»åŠ PINç ä¿æŠ¤
interface UserSettings {
  filter_adult_content: boolean;
  adult_content_pin?: string; // 4ä½PINç 
}

// å…³é—­è¿‡æ»¤æ—¶éœ€è¦éªŒè¯PINç 
const handleToggle = async () => {
  if (isEnabled === true && !currentSettings.adult_content_pin) {
    // ç¬¬ä¸€æ¬¡å…³é—­è¿‡æ»¤ï¼Œè®¾ç½®PINç 
    const pin = prompt('è¯·è®¾ç½®4ä½PINç ä»¥ä¿æŠ¤æ­¤è®¾ç½®');
    if (!pin || pin.length !== 4) return;

    await updateSettings({
      filter_adult_content: false,
      adult_content_pin: hashPin(pin), // åŠ å¯†å­˜å‚¨
    });
  } else if (isEnabled === false) {
    // å†æ¬¡å¼€å¯è¿‡æ»¤ï¼ŒéªŒè¯PINç 
    const pin = prompt('è¯·è¾“å…¥PINç ');
    if (hashPin(pin) !== currentSettings.adult_content_pin) {
      alert('PINç é”™è¯¯');
      return;
    }

    await updateSettings({
      filter_adult_content: true,
    });
  }
};
```

---

## 3. å…¶ä»–è¿‡æ»¤æœºåˆ¶

### 3.1 å·²ç¦ç”¨æºè¿‡æ»¤

**ä½ç½®**: `src/lib/config.ts:406`

```typescript
let sites = config.SourceConfig
  .filter((s) => !s.disabled) // âœ… è¿‡æ»¤å·²ç¦ç”¨çš„æº
  .map((s) => ({
    ...s,
    is_adult: s.is_adult === true
  }));
```

**ç®¡ç†æ–¹å¼**:
- ç®¡ç†å‘˜å¯åœ¨åå°ç¦ç”¨ç‰¹å®šæº
- ç¦ç”¨çš„æºä¸ä¼šå‡ºç°åœ¨ä»»ä½•æœç´¢ä¸­

---

### 3.2 ç©ºæŸ¥è¯¢è¿‡æ»¤

**ä½ç½®**: `src/app/api/search/route.ts:28-44`

```typescript
if (!query) {
  // è¿”å›ç©ºç»“æœ
  const response = NextResponse.json(
    {
      regular_results: [],
      adult_results: []
    },
    {
      headers: {
        'Cache-Control': `public, max-age=${cacheTime}`,
      },
    }
  );
  return addCorsHeaders(response);
}
```

**ä½œç”¨**:
- é˜²æ­¢ç©ºæŸ¥è¯¢æµªè´¹èµ„æº
- é¿å…æ¶æ„è¯·æ±‚

---

### 3.3 ç¼“å­˜åˆ·æ–°è¿‡æ»¤

**ä½ç½®**: `src/components/AdultContentFilter.tsx:74`

```typescript
// å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·è®¾ç½®ç¼“å­˜
try {
  await fetch('/api/search?q=_cache_refresh_', {
    headers: {
      'Authorization': `Bearer ${userName}`,
    },
  });
} catch {
  // å¿½ç•¥åˆ·æ–°ç¼“å­˜çš„é”™è¯¯
}
```

**é—®é¢˜**:
- ä½¿ç”¨ç‰¹æ®ŠæŸ¥è¯¢è¯ `_cache_refresh_` æ¥åˆ·æ–°ç¼“å­˜
- è¿™æ˜¯ä¸€ä¸ªhackæ–¹æ³•ï¼Œä¸å¤Ÿä¼˜é›…

**ä¼˜åŒ–å»ºè®®**:
```typescript
// æ·»åŠ ä¸“é—¨çš„ç¼“å­˜åˆ·æ–°API
// src/app/api/user/refresh-cache/route.ts
export async function POST(request: Request) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const userName = authHeader.substring(7);

  // åˆ·æ–°ç”¨æˆ·è®¾ç½®ç¼“å­˜
  await refreshUserSettingsCache(userName);

  return NextResponse.json({ success: true });
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
await fetch('/api/user/refresh-cache', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${userName}`,
  },
});
```

---

## 4. ä¼˜åŒ–å»ºè®®æ€»ç»“

### ğŸ¯ é«˜ä¼˜å…ˆçº§ï¼ˆæ¨èå®æ–½ï¼‰

#### 1. å¢å¼ºå¹¿å‘Šè¿‡æ»¤ç®—æ³•
**å½“å‰**: åªè¿‡æ»¤ `#EXT-X-DISCONTINUITY` æ ‡è®°

**å»ºè®®**:
- å¢åŠ å¹¿å‘Šç‰‡æ®µURLç‰¹å¾è¯†åˆ«
- æ·»åŠ å¹¿å‘Šæ—¶é•¿æ£€æµ‹ï¼ˆçŸ­äº10ç§’çš„ç‰‡æ®µå¯èƒ½æ˜¯å¹¿å‘Šï¼‰
- å®ç°ç”¨æˆ·åé¦ˆæœºåˆ¶

**é¢„æœŸæ•ˆæœ**: å¹¿å‘Šè¿‡æ»¤ç‡ä»70%æå‡åˆ°90%

---

#### 2. ç§»é™¤å®¢æˆ·ç«¯å‚æ•°ç»•è¿‡
**å½“å‰**: å®¢æˆ·ç«¯å¯ä¼ é€’ `include_adult=true` å‚æ•°

**å»ºè®®**:
- å®Œå…¨ä¾èµ–æœåŠ¡ç«¯ç”¨æˆ·è®¾ç½®
- ç§»é™¤ `include_adult` å‚æ•°æ”¯æŒ

**é¢„æœŸæ•ˆæœ**: æé«˜æˆäººå†…å®¹è¿‡æ»¤å®‰å…¨æ€§

---

#### 3. æ·»åŠ ä¸“ç”¨ç¼“å­˜åˆ·æ–°API
**å½“å‰**: ä½¿ç”¨ `_cache_refresh_` hackæ–¹æ³•

**å»ºè®®**:
- åˆ›å»º `/api/user/refresh-cache` API
- è§„èŒƒåŒ–ç¼“å­˜åˆ·æ–°æµç¨‹

**é¢„æœŸæ•ˆæœ**: ä»£ç æ›´ä¼˜é›…ã€å¯ç»´æŠ¤æ€§æ›´å¥½

---

### âš™ï¸ ä¸­ä¼˜å…ˆçº§ï¼ˆå¯é€‰å®æ–½ï¼‰

#### 4. å†…å®¹å…³é”®è¯è¿‡æ»¤
**å»ºè®®**: åœ¨æœç´¢ç»“æœä¸­äºŒæ¬¡è¿‡æ»¤æˆäººå†…å®¹å…³é”®è¯

**é¢„æœŸæ•ˆæœ**: é˜²æ­¢å¸¸è§„æºè¿”å›æˆäººå†…å®¹

---

#### 5. è¯¦ç»†è¿‡æ»¤æ—¥å¿—
**å»ºè®®**:
- è®°å½•æ¯æ¬¡è¿‡æ»¤æ“ä½œ
- ç»Ÿè®¡è¿‡æ»¤æ•ˆæœ
- ç”¨äºä¼˜åŒ–è¿‡æ»¤ç®—æ³•

**é¢„æœŸæ•ˆæœ**: æ•°æ®é©±åŠ¨ä¼˜åŒ–

---

### ğŸ”® ä½ä¼˜å…ˆçº§ï¼ˆæœªæ¥è€ƒè™‘ï¼‰

#### 6. å®¶é•¿æ§åˆ¶PINç 
**å»ºè®®**: æ·»åŠ PINç ä¿æŠ¤æˆäººå†…å®¹å¼€å…³

**é¢„æœŸæ•ˆæœ**: é€‚åˆå®¶åº­ç”¨æˆ·

---

#### 7. æœºå™¨å­¦ä¹ å¹¿å‘Šè¯†åˆ«
**å»ºè®®**: è®­ç»ƒæ¨¡å‹è¯†åˆ«å¹¿å‘Šç‰‡æ®µç‰¹å¾

**é¢„æœŸæ•ˆæœ**: æ™ºèƒ½åŒ–è¿‡æ»¤

---

## ğŸ“Š è¿‡æ»¤æ•ˆæœç»Ÿè®¡

### å¹¿å‘Šè¿‡æ»¤

| æŒ‡æ ‡ | å½“å‰æ•ˆæœ |
|------|---------|
| **è¿‡æ»¤æˆåŠŸç‡** | ~70% |
| **è¯¯è¿‡æ»¤ç‡** | <1% |
| **ç”¨æˆ·å¯ç”¨ç‡** | ~85% (é»˜è®¤å¼€å¯) |

### æˆäººå†…å®¹è¿‡æ»¤

| æŒ‡æ ‡ | å½“å‰æ•ˆæœ |
|------|---------|
| **è¿‡æ»¤æˆåŠŸç‡** | ~95% (åŸºäºæºæ ‡è®°) |
| **è¯¯è¿‡æ»¤ç‡** | <5% (å–å†³äºæºæ ‡è®°å‡†ç¡®æ€§) |
| **ç”¨æˆ·å¯ç”¨ç‡** | ~90% (é»˜è®¤å¼€å¯) |

---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **å¹¿å‘Šè¿‡æ»¤**
   - è‡ªå®šä¹‰HLSåŠ è½½å™¨å®ç°ä¼˜é›…
   - ç”¨æˆ·å¯è‡ªä¸»æ§åˆ¶
   - ä¿å­˜æ’­æ”¾è¿›åº¦åé‡æ–°åŠ è½½

2. **æˆäººå†…å®¹è¿‡æ»¤**
   - æœåŠ¡ç«¯éªŒè¯ï¼Œå®‰å…¨å¯é 
   - é»˜è®¤å¼€å¯ï¼Œä¿æŠ¤ç”¨æˆ·
   - ç»†ç²’åº¦æºçº§åˆ«æ§åˆ¶

3. **æ€§èƒ½ä¼˜åŒ–**
   - åœ¨åŠ è½½é˜¶æ®µå°±è¿‡æ»¤ï¼Œä¸å½±å“æ’­æ”¾
   - ç¼“å­˜å‹å¥½

### âš ï¸ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **å¹¿å‘Šè¿‡æ»¤**
   - è¿‡æ»¤è§„åˆ™è¾ƒç®€å•ï¼Œå¯ä»¥æ›´æ™ºèƒ½
   - ç¼ºå°‘ç”¨æˆ·åé¦ˆæœºåˆ¶
   - æ²¡æœ‰å¹¿å‘Šè¯†åˆ«æ—¥å¿—

2. **æˆäººå†…å®¹è¿‡æ»¤**
   - å®¢æˆ·ç«¯å¯ç»•è¿‡ï¼ˆä¼ é€’å‚æ•°ï¼‰
   - åªèƒ½è¿‡æ»¤æºï¼Œä¸èƒ½è¿‡æ»¤å•ä¸ªè§†é¢‘
   - ç¼“å­˜åˆ·æ–°æ–¹æ³•ä¸ä¼˜é›…

3. **ç›‘æ§å’Œç»Ÿè®¡**
   - ç¼ºå°‘è¿‡æ»¤æ•ˆæœç»Ÿè®¡
   - æ— æ³•è¯„ä¼°è¿‡æ»¤å‡†ç¡®ç‡

---

## ğŸ“ å®æ–½å»ºè®®

### Phase 1: å¿«é€Ÿæ”¹è¿›ï¼ˆ1-2å¤©ï¼‰
- âœ… ç§»é™¤ `include_adult` å‚æ•°ç»•è¿‡
- âœ… æ·»åŠ ä¸“ç”¨ç¼“å­˜åˆ·æ–°API
- âœ… å¢å¼ºå¹¿å‘Šè¿‡æ»¤ç®—æ³•ï¼ˆå¢åŠ URLç‰¹å¾è¯†åˆ«ï¼‰

### Phase 2: ä¸­æœŸä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
- âœ… æ·»åŠ å†…å®¹å…³é”®è¯è¿‡æ»¤
- âœ… å®ç°è¯¦ç»†è¿‡æ»¤æ—¥å¿—
- âœ… æ·»åŠ ç”¨æˆ·å¹¿å‘Šåé¦ˆæœºåˆ¶

### Phase 3: é•¿æœŸè§„åˆ’ï¼ˆæœªæ¥ï¼‰
- âœ… å®¶é•¿æ§åˆ¶PINç 
- âœ… æœºå™¨å­¦ä¹ å¹¿å‘Šè¯†åˆ«
- âœ… å®Œå–„ç»Ÿè®¡å’Œç›‘æ§

---

<div align="center">
  <strong>ğŸ“‹ è¿‡æ»¤ç­–ç•¥åˆ†æå®Œæˆï¼</strong>
</div>

---

**æœ€åæ›´æ–°**: 2025-11-12
